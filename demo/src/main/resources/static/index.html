<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SmartShift - Home</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="navbar">
    <a href="index.html" class="active">Home</a>
    <a href="calendario.html">Calendario</a>
    <a href="dipendenti.html">Gestione Dipendenti</a>
</div>

<div class="container">
    <div class="card">
        <h1>Benvenuto in SmartShift</h1>
        <p>Ecco la programmazione per la <strong>Settimana Corrente</strong>.</p>
        <div id="date-range" style="margin-bottom: 15px; font-weight: bold; color: #666;"></div>
        
        <table id="tabella-home">
            <thead>
                <tr>
                    <th>Giorno</th>
                    <th>Orario</th>
                    <th>Dipendente</th>
                </tr>
            </thead>
            <tbody id="corpo-home">
                <tr><td colspan="3" style="text-align:center;">Caricamento turni...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Utility per le date
    function getMonday(d) {
        d = new Date(d);
        var day = d.getDay(),
            diff = d.getDate() - day + (day == 0 ? -6 : 1); 
        return new Date(d.setDate(diff));
    }

    async function caricaHome() {
        const oggi = new Date();
        const lunedi = getMonday(oggi);
        const domenica = new Date(lunedi);
        domenica.setDate(lunedi.getDate() + 6);

        // Mostra range date
        document.getElementById('date-range').innerText = 
            `Dal ${lunedi.toLocaleDateString()} al ${domenica.toLocaleDateString()}`;

        // Fetch di TUTTI i turni (poi filtriamo lato client)
        // NOTA: Se il backend supporta filtri per data, meglio usarli l√¨!
        const res = await fetch('/api/turni');
        const turni = await res.json();

        // Filtra solo turni di questa settimana
        const turniSettimana = turni.filter(t => {
            const dataTurno = new Date(t.data);
            // Azzera ore per confronto preciso
            dataTurno.setHours(0,0,0,0);
            lunedi.setHours(0,0,0,0);
            domenica.setHours(23,59,59,999);
            return dataTurno >= lunedi && dataTurno <= domenica;
        });

        // Ordina
        turniSettimana.sort((a, b) => (a.data + a.oraInizio).localeCompare(b.data + b.oraInizio));

        // Render
        const tbody = document.getElementById('corpo-home');
        tbody.innerHTML = '';
        
        if(turniSettimana.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Nessun turno pianificato per questa settimana. <a href="calendario.html">Vai al Calendario</a></td></tr>';
            return;
        }

        let lastDate = '';
        turniSettimana.forEach(t => {
            // Raggruppamento visivo per giorno
            if (t.data !== lastDate) {
                tbody.innerHTML += `<tr style="background:#f1f8ff;"><td colspan="3"><strong>${t.data}</strong></td></tr>`;
                lastDate = t.data;
            }
            tbody.innerHTML += `
                <tr>
                    <td></td>
                    <td>‚è∞ ${t.oraInizio} - ${t.oraFine}</td>
                    <td>üë§ ${t.dipendente.cognome} ${t.dipendente.nome}</td>
                </tr>
            `;
        });
    }

    caricaHome();
</script>

</body>
</html>