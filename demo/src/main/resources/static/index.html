<!DOCTYPE html>
<html lang="it">
<head>
    <!--
        PAGINA HOME che si occupa di
        - mostrare la pagina di riepilogo settimanale
        - mostrare i turni della settimana corrente,
          evidenziando il giorno corrente
    -->
    <meta charset="UTF-8">
    <title>SmartShift - Home</title>
    <link rel="stylesheet" href="style.css"> <!-- Foglio di stile globale dell'applicazione -->
</head>
<body>

<!-- BARRA DI NAVIGAZIONE per navigare tra le varie sezioni-->
    <div class="navbar">
    <a href="index.html" class="active">Home</a>
    <a href="calendario.html">Calendario</a>
    <a href="dipendenti.html">Gestione Dipendenti</a>
</div>

<!-- CONTENITORE PRINCIPALE DELLA HOME -->
<div class="container" style="max-width: 1400px;"> <div class="card" style="margin-bottom: 20px;">
        <h1 style="margin-bottom: 5px;">Benvenuto in SmartShift</h1>
        <!-- Intestazione della settimana, si aggiorna dinamicamente-->
        <p id="intestazione-settimana" style="color: #666; font-size: 1.1em; margin-top: 0;">
            Caricamento date...
        </p>
    </div>

    <!-- Griglia dei 7 giorni della settimana  -->
    <div id="griglia-home" class="calendar-grid">
        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">Caricamento turni in corso...</div>
    </div>

</div>

<script>
    // Utility per formattazione delle date nel formato YYYY-MM-DD 
    function getYMD(d) {
        return d.toLocaleDateString('en-CA');
    }

    // Utility per trovare il lunedÃ¬ della settimana corrente
    function getMonday(d) {
        d = new Date(d);
        var day = d.getDay(),
            diff = d.getDate() - day + (day == 0 ? -6 : 1); 
        return new Date(d.setDate(diff));
    }

    //  CARICAMENTO HOME E RIEPILOGO SETTIMANALE
    async function caricaHome() {
        const oggi = new Date();
        const lunedi = getMonday(oggi);
        const domenica = new Date(lunedi);
        domenica.setDate(lunedi.getDate() + 6);

        // Intestazione settimana
        const optsDate = { day: 'numeric', month: 'long', year: 'numeric' };
        document.getElementById('intestazione-settimana').innerHTML = 
            `Ecco la programmazione per la settimana dal <strong>${lunedi.toLocaleDateString('it-IT', optsDate)}</strong> al <strong>${domenica.toLocaleDateString('it-IT', optsDate)}</strong>`;

        try {
            // Fetch dei dati dei turni
            const res = await fetch('/api/turni');
            const turni = await res.json();

            // Preparazione rendering della griglia
            const container = document.getElementById('griglia-home');
            container.innerHTML = ''; // Rimuove loader iniziale

            // Ciclo sui 7 giorni della settimana considerata
            for (let i = 0; i < 7; i++) {
                let currentDay = new Date(lunedi);
                currentDay.setDate(lunedi.getDate() + i);
                
                let dateKey = getYMD(currentDay);
                let isToday = getYMD(oggi) === dateKey;

                // Filtra i turni per il giorno corrente
                let turniGiorno = turni.filter(t => t.data === dateKey);
                
                // Ordina per orario di inizio del turno
                turniGiorno.sort((a, b) => a.oraInizio.localeCompare(b.oraInizio));

                // Costruzione del giorno
                let htmlContent = `
                    <div class="day-column ${isToday ? 'today' : ''}">
                        <div class="day-header">
                            ${currentDay.toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: '2-digit' })}
                        </div>
                        <div class="day-body">
                `;

                // Se non ci sono turni mostra un placeholder
                if (turniGiorno.length === 0) {
                    htmlContent += `<div class="day-empty">-</div>`;
                } else {
                    // Render card per ogni turno
                    turniGiorno.forEach(t => {
                        htmlContent += `
                            <div class="shift-card">
                                <div class="shift-time">
                                    ${t.oraInizio.substring(0, 5)} - ${t.oraFine.substring(0, 5)}
                                </div>
                                <div class="user-name">
                                    ðŸ‘¤ ${t.dipendente.cognome} ${t.dipendente.nome}
                                </div>
                            </div>
                        `;
                    });
                }

                htmlContent += `</div></div>`; // Chiude day-body e day-column
                container.innerHTML += htmlContent;
            }

        } catch (error) {
            // Gestione errore di caricamento dell'API
            console.error("Errore:", error);
            document.getElementById('griglia-home').innerHTML = '<div style="color:red; text-align:center;">Errore nel caricamento dei turni.</div>';
        }
    }

     // Avvio automatico al caricamento della pagina
    caricaHome();
</script>

</body>
</html>