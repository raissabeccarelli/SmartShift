<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SmartShift - Dipendenti</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="navbar">
    <a href="index.html">Home</a>
    <a href="calendario.html">Calendario</a>
    <a href="dipendenti.html" class="active">Gestione Dipendenti</a>
</div>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>Il tuo Team</h1>
        <button class="btn-success" onclick="apriModalCrea()">+ Nuovo Dipendente</button>
    </div>

    <table id="tabella-dipendenti" class="card">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Cognome</th>
                <th>Contratto (h)</th>
                <th>Azioni</th>
            </tr>
        </thead>
        <tbody id="listaDipendenti"></tbody>
    </table>
</div>

<div id="modalDipendente" class="modal">
    <div class="modal-content">
        <span class="close" onclick="chiudiModals()">&times;</span>
        <h2 id="modalTitleDip">Nuovo Dipendente</h2>
        <input type="hidden" id="editId">
        
        <label>Nome</label>
        <input type="text" id="nome">
        <label>Cognome</label>
        <input type="text" id="cognome">
        <label>Ore Settimanali</label>
        <input type="number" id="oreSett" min="0" max="40">
        <label>Max Ore Giornaliere</label>
        <input type="number" id="oreMax" min="0" max="8">
        
        <button class="btn-primary" onclick="salvaDipendente()">Salva</button>
    </div>
</div>

<div id="modalAssenze" class="modal">
    <div class="modal-content">
        <span class="close" onclick="chiudiModals()">&times;</span>
        <h2>Inserisci Assenza</h2>
        <p>Dipendente: <strong id="assenzeDipName"></strong></p>
        <input type="hidden" id="assenzeDipId">

        <label>Data</label>
        <input type="date" id="dataAssenza">
        
        <label>Tipo Assenza</label>
        <select id="tipoAssenza">
            <option value="FERIE">Ferie</option>
            <option value="MALATTIA">Malattia</option>
            <option value="PERMESSO">Permesso</option>
        </select>

        <label>Motivazione (Opzionale)</label>
        <textarea id="motivazione" rows="3"></textarea>

        <button class="btn-primary" onclick="salvaAssenza()">Registra Assenza</button>
    </div>
</div>

<script>
    // --- GESTIONE LISTA ---
    async function caricaDipendenti() {
        const res = await fetch('/api/turni/dipendenti');
        const list = await res.json();
        const tbody = document.getElementById('listaDipendenti');
        tbody.innerHTML = '';

        list.forEach(d => {
            tbody.innerHTML += `
                <tr>
                    <td>${d.nome}</td>
                    <td>${d.cognome}</td>
                    <td>${d.oreSettimanaliContratto}h</td>
                    <td>
                        <button class="btn-sm btn-primary" onclick='apriModifica(${JSON.stringify(d)})'>Modifica</button>
                        <button class="btn-sm btn-secondary" onclick="apriAssenze(${d.id}, '${d.cognome}')">Assenze</button>
                        <button class="btn-sm btn-danger" onclick="elimina(${d.id})">Elimina</button>
                    </td>
                </tr>
            `;
        });
    }

    // --- LOGICA MODIFICA / CREAZIONE ---
    function apriModalCrea() {
        document.getElementById('modalTitleDip').innerText = "Nuovo Dipendente";
        document.getElementById('editId').value = "";
        
        const inputNome = document.getElementById('nome');
        const inputCognome = document.getElementById('cognome');

        // Puliamo i valori
        inputNome.value = "";
        inputCognome.value = "";
        document.getElementById('oreSett').value = "";
        document.getElementById('oreMax').value = "";

        // --- SBLOCCO MODIFICHE (Reset) ---
        // Se vengo da una modifica, devo riabilitare la scrittura
        inputNome.readOnly = false;
        inputCognome.readOnly = false;
        
        // Ripristino il colore bianco
        inputNome.style.backgroundColor = "white";
        inputCognome.style.backgroundColor = "white";
        inputNome.style.cursor = "text";
        inputCognome.style.cursor = "text";

        document.getElementById('modalDipendente').style.display = 'flex';
    }

    function apriModifica(d) {
        document.getElementById('modalTitleDip').innerText = "Modifica Dipendente";
        document.getElementById('editId').value = d.id;
        
        // Riempiamo i campi
        const inputNome = document.getElementById('nome');
        const inputCognome = document.getElementById('cognome');
        
        inputNome.value = d.nome;
        inputCognome.value = d.cognome;
        document.getElementById('oreSett').value = d.oreSettimanaliContratto;
        document.getElementById('oreMax').value = d.oreGiornaliereMax;

        // --- BLOCCO MODIFICHE ANAGRAFICA ---
        // Impostiamo sola lettura
        inputNome.readOnly = true;
        inputCognome.readOnly = true;
        
        // Cambiamo colore per far capire che sono bloccati (grigino)
        inputNome.style.backgroundColor = "#e9ecef";
        inputCognome.style.backgroundColor = "#e9ecef";
        inputNome.style.cursor = "not-allowed";
        inputCognome.style.cursor = "not-allowed";

        document.getElementById('modalDipendente').style.display = 'flex';
    }

    async function salvaDipendente() {
        const id = document.getElementById('editId').value;
        const nome = document.getElementById('nome').value;
        const cognome = document.getElementById('cognome').value;
        
        // Convertiamo i valori in numeri
        const oreSett = Number(document.getElementById('oreSett').value);
        const oreMax = Number(document.getElementById('oreMax').value);

        // --- INIZIO CONTROLLI DI VALIDITÀ ---

        // 1. Controllo campi vuoti
        if (!nome || !cognome || document.getElementById('oreSett').value === "" || document.getElementById('oreMax').value === "") {
            alert("Compila tutti i campi prima di salvare.");
            return; 
        }

        // 2. Controllo Ore Settimanali (No negativi, Max 40)
        if (oreSett < 0 || oreSett > 40) {
            alert("ERRORE: Le ore settimanali devono essere comprese tra 0 e 40!");
            return; 
        }

        // 3. Controllo Ore Giornaliere (No negativi, Max 8)
        if (oreMax < 0 || oreMax > 8) {
            alert("ERRORE: Le ore giornaliere devono essere comprese tra 0 e 8!");
            return; 
        }

        // --- FINE CONTROLLI ---

        const dip = {
            id: id ? id : null, 
            nome: nome,
            cognome: cognome,
            oreSettimanaliContratto: oreSett,
            oreGiornaliereMax: oreMax
        };

        try {
            const res = await fetch('/api/turni/dipendenti', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(dip)
            });

            if(res.ok) {
                chiudiModals();
                caricaDipendenti();
                // alert("Dipendente salvato con successo!"); // Togli il commento se vuoi la conferma
            } else {
                alert("Errore durante il salvataggio.");
            }
        } catch (e) {
            console.error(e);
            alert("Errore di connessione al server.");
        }
    }

    // --- LOGICA ASSENZE ---
    function apriAssenze(id, cognome) {
        document.getElementById('assenzeDipId').value = id;
        document.getElementById('assenzeDipName').innerText = cognome;
        document.getElementById('modalAssenze').style.display = 'flex';
    }

   async function salvaAssenza() {
        const id = document.getElementById('assenzeDipId').value;
        const data = document.getElementById('dataAssenza').value;
        const tipo = document.getElementById('tipoAssenza').value;

        if(!data) return alert("Inserisci la data");

        // INVIO DEI DATI IN FORMATO JSON (Più robusto)
        const res = await fetch('/api/turni/assenza', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                dipendenteId: id, 
                data: data, 
                tipo: tipo 
            })
        });

        if (res.ok) {
            alert("Assenza registrata con successo!");
            chiudiModals();
            // Ricarica la pagina per aggiornare eventuali visualizzazioni
            location.reload(); 
        } else {
            alert("Errore nel salvataggio dell'assenza.");
        }
    }

    async function elimina(id) {
    if(confirm("Sei sicuro di voler eliminare questo dipendente? I suoi turni e assenze verranno rimossi.")) {
        try {
            const res = await fetch('/api/turni/dipendenti/' + id, { 
                method: 'DELETE' 
            });

            if(res.ok) {
                caricaDipendenti(); // Ricarica la tabella
            } else {
                alert("Errore durante l'eliminazione.");
            }
        } catch (e) {
            console.error(e);
            alert("Errore di connessione.");
        }
    }
    }

    function chiudiModals() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }

    // Avvio
    caricaDipendenti();
</script>

</body>
</html>