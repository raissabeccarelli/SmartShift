<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SmartShift - Dipendenti</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .btn-info {
            background-color: #17a2b8; color: white;
        }
        .btn-info:hover {
            background-color: #138496;
        }
        
        /* Stile per il box statistiche */
        .stat-box {
            background: #e3f2fd; padding: 15px; border-radius: 6px; 
            margin-top: 10px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .stat-row {
            display: flex; justify-content: space-around; width: 100%;
        }
        .stat-item { text-align: center; width: 45%; }
        .stat-label { display:block; font-size: 0.8em; color: #555; margin-bottom: 2px; }
        .stat-value { font-size: 1.3em; font-weight: bold; }
        
        /* Colori specifici */
        .val-ferie { color: #0288d1; }
        .val-residuo { color: #2e7d32; }
        .val-malattia { color: #d32f2f; }
        .val-permesso { color: #f57c00; }

        .history-container {
            max-height: 250px; overflow-y: auto; 
            border: 1px solid #eee; border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="navbar">
    <a href="index.html">Home</a>
    <a href="calendario.html">Calendario</a>
    <a href="dipendenti.html" class="active">Gestione Dipendenti</a>
</div>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>Il tuo Team</h1>
        <button class="btn-success" onclick="apriModalCrea()">+ Nuovo Dipendente</button>
    </div>

    <table id="tabella-dipendenti" class="card">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Cognome</th>
                <th>Contratto (h)</th>
                <th>Azioni</th>
            </tr>
        </thead>
        <tbody id="listaDipendenti"></tbody>
    </table>
</div>

<div id="modalDipendente" class="modal">
    <div class="modal-content">
        <span class="close" onclick="chiudiModals()">&times;</span>
        <h2 id="modalTitleDip">Nuovo Dipendente</h2>
        <input type="hidden" id="editId">
        
        <label>Nome</label>
        <input type="text" id="nome">
        <label>Cognome</label>
        <input type="text" id="cognome">
        <label>Tipo Contratto</label>
        <select id="tipoContratto" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <option value="FULL_TIME">Full Time</option>
            <option value="PART_TIME">Part Time</option>
        </select>

<input type="hidden" id="oreSett">
<input type="hidden" id="oreMax">
        
        <button class="btn-primary" onclick="salvaDipendente()">Salva</button>
    </div>
</div>

<div id="modalAssenze" class="modal">
    <div class="modal-content" style="max-width: 650px;">
        <span class="close" onclick="chiudiModals()">&times;</span>
        
        <div style="border-bottom: 1px solid #ddd; margin-bottom: 15px; padding-bottom: 10px;">
            <h2 style="margin: 0;">Gestione Assenze</h2>
            <p style="color: #666; margin: 5px 0;">Dipendente: <strong id="assenzeDipName"></strong></p>
            
            <div class="stat-box">
                <div class="stat-row" style="border-bottom: 1px dashed #bcdbf3; padding-bottom: 8px;">
                    <div class="stat-item">
                        <span class="stat-label">Ferie Godute</span>
                        <strong id="statFerieGodute" class="stat-value val-ferie">0</strong>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Ferie Residue</span>
                        <strong id="statFerieResidue" class="stat-value val-residuo">0</strong>
                    </div>
                </div>
                <div class="stat-row">
                    <div class="stat-item">
                        <span class="stat-label">Giorni Malattia</span>
                        <strong id="statMalattia" class="stat-value val-malattia">0</strong>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Giorni Permesso</span>
                        <strong id="statPermessi" class="stat-value val-permesso">0</strong>
                    </div>
                </div>
            </div>
        </div>

        <input type="hidden" id="assenzeDipId">

        <h4 style="margin-bottom: 10px;">➕ Nuova Assenza</h4>
        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label style="font-size: 0.85em;">Dal</label>
                    <input type="date" id="dataInizio" style="width: 100%; padding: 5px;" onchange="aggiornaDataFine()">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 0.85em;">Al</label>
                    <input type="date" id="dataFine" style="width: 100%; padding: 5px;">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 0.85em;">Tipo</label>
                    <select id="tipoAssenza" style="width: 100%; padding: 6px;">
                        <option value="FERIE">Ferie</option>
                        <option value="MALATTIA">Malattia</option>
                        <option value="PERMESSO">Permesso</option>
                    </select>
                </div>
            </div>
            <textarea id="motivazione" rows="1" placeholder="Motivazione (opzionale)..." style="width: 100%; margin-top: 10px; font-size: 0.9em;"></textarea>
            <button class="btn-primary" onclick="salvaAssenza()" style="width: 100%; margin-top: 10px;">Registra Assenza</button>
        </div>

        <h4 style="margin-top: 20px; margin-bottom: 10px;">Storico Assenze</h4>
        <div class="history-container">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                <thead style="background: #f1f1f1; position: sticky; top: 0;">
                    <tr>
                        <th style="padding: 8px; text-align: left;">Data</th>
                        <th style="padding: 8px; text-align: left;">Tipo</th>
                        <th style="padding: 8px; text-align: left;">Motivazione</th>
                        <th style="padding: 8px; text-align: center;">Azioni</th>
                    </tr>
                </thead>
                <tbody id="listaAssenzeStorico"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const FERIE_ANNUALI_STANDARD = 26; // Non usiamo più questo per il calcolo residuo, ma lo teniamo come riferimento
    let currentEmployeeAbsences = []; 

    // --- DIPENDENTI ---
    async function caricaDipendenti() {
        try {
            const res = await fetch('/api/turni/dipendenti');
            const list = await res.json();
            const tbody = document.getElementById('listaDipendenti');
            tbody.innerHTML = '';

            list.forEach(d => {
                tbody.innerHTML += `
                    <tr>
                        <td>${d.nome}</td>
                        <td>${d.cognome}</td>
                        <td>${d.oreSettimanaliContratto}h</td>
                        <td>
                            <button class="btn-sm btn-primary" onclick='apriModifica(${JSON.stringify(d)})'>Modifica</button>
                            <button class="btn-sm btn-info" onclick="apriAssenze(${d.id}, '${d.nome} ${d.cognome}', ${d.ferieResidue})">Gestisci Assenze</button>
                            <button class="btn-sm btn-danger" onclick="elimina(${d.id})">Elimina</button>
                        </td>
                    </tr>
                `;
            });
        } catch (e) { console.error(e); }
    }

    function apriModalCrea() {
        document.getElementById('modalTitleDip').innerText = "Nuovo Dipendente";
        document.getElementById('editId').value = "";
        document.getElementById('nome').value = "";
        document.getElementById('cognome').value = "";
        document.getElementById('oreSett').value = "";
        document.getElementById('oreMax').value = "";
        
        const nomeIn = document.getElementById('nome');
        const cognIn = document.getElementById('cognome');
        nomeIn.readOnly = false; cognIn.readOnly = false;
        nomeIn.style.backgroundColor = "white"; cognIn.style.backgroundColor = "white";
        
        document.getElementById('modalDipendente').style.display = 'flex';
    }

    function apriModifica(d) {
        document.getElementById('modalTitleDip').innerText = "Modifica Dipendente";
        document.getElementById('editId').value = d.id;
        document.getElementById('nome').value = d.nome;
        document.getElementById('cognome').value = d.cognome;

        // Seleziona automaticamente l'opzione corretta nel menu a tendina
        const selectContratto = document.getElementById('tipoContratto');
        if (d.oreSettimanaliContratto >= 40) {
            selectContratto.value = "FULL_TIME";
        } else {
            selectContratto.value = "PART_TIME";
        }

        // Gestione campi nome e cognome (sola lettura in modifica)
        const nomeIn = document.getElementById('nome');
        const cognIn = document.getElementById('cognome');
        nomeIn.readOnly = true; 
        cognIn.readOnly = true;
        nomeIn.style.backgroundColor = "#e9ecef"; 
        cognIn.style.backgroundColor = "#e9ecef";

        // Mostra il modal
        document.getElementById('modalDipendente').style.display = 'flex';
    }

    async function salvaDipendente() {
        const id = document.getElementById('editId').value;
        const nome = document.getElementById('nome').value;
        const cognome = document.getElementById('cognome').value;
        const tipoContratto = document.getElementById('tipoContratto').value;

        // Logica di assegnazione automatica
        let oreSett, oreMax;
        if (tipoContratto === "FULL_TIME") {
            oreSett = 40;
            oreMax = 8;
        } else {
            oreSett = 20;
            oreMax = 4;
        }

        if (!nome || !cognome) {
            return alert("Compila nome e cognome");
        }

        const dip = { 
            id: id ? id : null, 
            nome, 
            cognome, 
            oreSettimanaliContratto: oreSett, 
            oreGiornaliereMax: oreMax 
        };

        try {
            const res = await fetch('/api/turni/dipendenti', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(dip)
            });
            if(res.ok) { 
                chiudiModals(); 
                caricaDipendenti(); 
            } 
            else alert("Errore salvataggio");
        } catch (e) { 
            alert("Errore connessione"); 
        }
     }

        // --- ASSENZE ---
    function aggiornaDataFine() {
        const inizio = document.getElementById('dataInizio').value;
        const fineInput = document.getElementById('dataFine');
        if (inizio) {
            if (!fineInput.value || fineInput.value < inizio) {
                  fineInput.value = inizio;
            }
        }
    }

    // MODIFICA 2: Riceviamo 'residuoReale' e lo mostriamo subito
    async function apriAssenze(id, nomeCompleto, residuoReale) {
        document.getElementById('assenzeDipId').value = id;
        document.getElementById('assenzeDipName').innerText = nomeCompleto;
        
        // Imposta il valore DIRETTAMENTE dal Database
        const elResiduo = document.getElementById('statFerieResidue');
        elResiduo.innerText = residuoReale;
        elResiduo.style.color = residuoReale < 0 ? 'red' : '#2e7d32';

        // Reset campi form
        document.getElementById('dataInizio').value = "";
        document.getElementById('dataFine').value = "";
        document.getElementById('motivazione').value = "";
        document.getElementById('tipoAssenza').value = "FERIE";

        await caricaAssenzeDipendente(id);
        document.getElementById('modalAssenze').style.display = 'flex';
    }

    async function caricaAssenzeDipendente(dipId) {
    const tbody = document.getElementById('listaAssenzeStorico');
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Caricamento...</td></tr>';

    try {
        const res = await fetch('/api/turni/assenze');
        const tutteAssenze = await res.json();

        // Filtro per ID dipendente
        const assenzeDip = tutteAssenze.filter(a => {
            const aId = a.dipendente ? a.dipendente.id : (a.dipendenteId || a.dipendente_id);
            return aId == dipId;
        });
        
        currentEmployeeAbsences = assenzeDip;
        assenzeDip.sort((a, b) => new Date(b.data) - new Date(a.data));

        tbody.innerHTML = '';
        if (assenzeDip.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">Nessuna assenza.</td></tr>';
            return; // Esci se non ci sono dati
        }

        let ferieGodute = 0;
        let malattiaCount = 0;
        let permessoCount = 0;

        assenzeDip.forEach(a => {
            // Conta le tipologie per le statistiche
            if (a.tipo === 'FERIE') ferieGodute++;
            else if (a.tipo === 'MALATTIA') malattiaCount++;
            else if (a.tipo === 'PERMESSO') permessoCount++;
            
            // Formattazione data
            const dataObj = new Date(a.data);
            const dataFmt = isNaN(dataObj) ? a.data : dataObj.toLocaleDateString('it-IT');

            const mot = a.motivazione || a.note || "-";

            tbody.innerHTML += `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px;">${dataFmt}</td>
                    <td style="padding: 8px;">${a.tipo}</td>
                    <td style="padding: 8px;"><small style="color:#666;">${mot}</small></td>
                    <td style="padding: 8px; text-align: center;">
                        <button class="btn-sm" style="background:transparent; color:red; border:none; cursor:pointer; font-weight:bold; font-size:1.2em;" 
                            onclick="eliminaAssenza(${a.id}, ${dipId})" title="Elimina">&times;</button>
                    </td>
                </tr>
            `;
        });

        // Aggiornamento box statistiche
        document.getElementById('statFerieGodute').innerText = ferieGodute;
        document.getElementById('statMalattia').innerText = malattiaCount;
        document.getElementById('statPermessi').innerText = permessoCount;

        } catch (e) { 
            console.error("Errore:", e); 
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Errore nel caricamento.</td></tr>';
        }
    }

    async function salvaAssenza() {
        const id = document.getElementById('assenzeDipId').value;
        const dataInizio = document.getElementById('dataInizio').value;
        const dataFine = document.getElementById('dataFine').value;
        const tipo = document.getElementById('tipoAssenza').value;
        const motivazione = document.getElementById('motivazione').value;

        if(!dataInizio || !dataFine) return alert("Inserisci il range di date (Dal - Al)");
        if(dataInizio > dataFine) return alert("La data fine non può essere prima dell'inizio");

        // --- CONTROLLO SOVRAPPOSIZIONI ---
        let checkDate = new Date(dataInizio);
        const endDateObj = new Date(dataFine);

        while (checkDate <= endDateObj) {
            const checkStr = checkDate.toISOString().split('T')[0];
            const conflitto = currentEmployeeAbsences.find(a => {
                const dataEsistente = typeof a.data === 'string' ? a.data.split('T')[0] : new Date(a.data).toISOString().split('T')[0];
                return dataEsistente === checkStr;
            });

            if (conflitto) {
                const dataLeggibile = checkDate.toLocaleDateString('it-IT');
                alert(`IMPOSSIBILE SALVARE:\nEsiste già un'assenza registrata per il giorno ${dataLeggibile} (${conflitto.tipo}).`);
                return;
            }
            checkDate.setDate(checkDate.getDate() + 1);
        }
        // --- FINE CONTROLLO ---

        const btn = document.querySelector('#modalAssenze .btn-primary');
        const originalText = btn.innerText;
        btn.innerText = "Salvataggio..."; btn.disabled = true;

        try {
            const res = await fetch('/api/turni/assenza', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    dipendenteId: id, 
                    dataInizio: dataInizio, 
                    dataFine: dataFine,
                    tipo: tipo, 
                    motivazione: motivazione 
                }) 
            });

            if (res.ok) {
                document.getElementById('dataInizio').value = "";
                document.getElementById('dataFine').value = "";
                document.getElementById('motivazione').value = "";
                await caricaAssenzeDipendente(id);
                // Ricarichiamo i dipendenti per aggiornare il residuo ferie nel DB se il backend lo ha scalato
                caricaDipendenti(); 
            } else {
                const err = await res.json();
                alert("Errore: " + (err.error || "Impossibile salvare"));
            }
        } catch(e) { console.error(e); alert("Errore connessione."); } 
        finally { btn.innerText = originalText; btn.disabled = false; }
    }

    async function eliminaAssenza(assenzaId, dipId) {
        if(!confirm("Vuoi eliminare questa assenza?")) return;
        try {
            const res = await fetch(`/api/turni/assenza/${assenzaId}`, { method: 'DELETE' });
            if (res.ok) {
                await caricaAssenzeDipendente(dipId);
                caricaDipendenti(); // Aggiorna il residuo generale
            }
            else alert("Impossibile eliminare.");
        } catch (e) { alert("Errore connessione."); }
    }

    async function elimina(id) {
        if(confirm("Eliminare dipendente?")) {
            try {
                const res = await fetch('/api/turni/dipendenti/' + id, { method: 'DELETE' });
                if(res.ok) caricaDipendenti();
                else alert("Errore eliminazione.");
            } catch (e) { alert("Errore connessione."); }
        }
    }

    function chiudiModals() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }

    caricaDipendenti();
</script>

</body>
</html>