<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SmartShift - Dipendenti</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="navbar">
    <a href="index.html">Home</a>
    <a href="calendario.html">Calendario</a>
    <a href="dipendenti.html" class="active">Gestione Dipendenti</a>
</div>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>Il tuo Team</h1>
        <button class="btn-success" onclick="apriModalCrea()">+ Nuovo Dipendente</button>
    </div>

    <table id="tabella-dipendenti" class="card">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Cognome</th>
                <th>Contratto (h)</th>
                <th>Azioni</th>
            </tr>
        </thead>
        <tbody id="listaDipendenti"></tbody>
    </table>
</div>

<div id="modalDipendente" class="modal">
    <div class="modal-content">
        <span class="close" onclick="chiudiModals()">&times;</span>
        <h2 id="modalTitleDip">Nuovo Dipendente</h2>
        <input type="hidden" id="editId">
        
        <label>Nome</label>
        <input type="text" id="nome">
        <label>Cognome</label>
        <input type="text" id="cognome">
        <label>Ore Settimanali</label>
        <input type="number" id="oreSett">
        <label>Max Ore Giornaliere</label>
        <input type="number" id="oreMax">
        
        <button class="btn-primary" onclick="salvaDipendente()">Salva</button>
    </div>
</div>

<div id="modalAssenze" class="modal">
    <div class="modal-content">
        <span class="close" onclick="chiudiModals()">&times;</span>
        <h2>Inserisci Assenza</h2>
        <p>Dipendente: <strong id="assenzeDipName"></strong></p>
        <input type="hidden" id="assenzeDipId">

        <label>Data</label>
        <input type="date" id="dataAssenza">
        
        <label>Tipo Assenza</label>
        <select id="tipoAssenza">
            <option value="FERIE">Ferie</option>
            <option value="MALATTIA">Malattia</option>
            <option value="PERMESSO">Permesso</option>
        </select>

        <label>Motivazione (Opzionale)</label>
        <textarea id="motivazione" rows="3"></textarea>

        <button class="btn-primary" onclick="salvaAssenza()">Registra Assenza</button>
    </div>
</div>

<script>
    // --- GESTIONE LISTA ---
    async function caricaDipendenti() {
        const res = await fetch('/api/turni/dipendenti');
        const list = await res.json();
        const tbody = document.getElementById('listaDipendenti');
        tbody.innerHTML = '';

        list.forEach(d => {
            tbody.innerHTML += `
                <tr>
                    <td>${d.nome}</td>
                    <td>${d.cognome}</td>
                    <td>${d.oreSettimanaliContratto}h</td>
                    <td>
                        <button class="btn-sm btn-primary" onclick='apriModifica(${JSON.stringify(d)})'>Modifica</button>
                        <button class="btn-sm btn-secondary" onclick="apriAssenze(${d.id}, '${d.cognome}')">Assenze</button>
                        <button class="btn-sm btn-danger" onclick="elimina(${d.id})">Elimina</button>
                    </td>
                </tr>
            `;
        });
    }

    // --- LOGICA MODIFICA / CREAZIONE ---
    function apriModalCrea() {
        document.getElementById('modalTitleDip').innerText = "Nuovo Dipendente";
        document.getElementById('editId').value = "";
        document.getElementById('nome').value = "";
        document.getElementById('cognome').value = "";
        document.getElementById('oreSett').value = "";
        document.getElementById('oreMax').value = "";
        document.getElementById('modalDipendente').style.display = 'flex';
    }

    function apriModifica(d) {
        document.getElementById('modalTitleDip').innerText = "Modifica Dipendente";
        document.getElementById('editId').value = d.id;
        document.getElementById('nome').value = d.nome;
        document.getElementById('cognome').value = d.cognome;
        document.getElementById('oreSett').value = d.oreSettimanaliContratto;
        document.getElementById('oreMax').value = d.oreGiornaliereMax;
        document.getElementById('modalDipendente').style.display = 'flex';
    }

    async function salvaDipendente() {
        const id = document.getElementById('editId').value;
        const dip = {
            id: id ? id : null, // Se c'è ID è modifica, altrimenti nuovo (il backend deve gestirlo)
            nome: document.getElementById('nome').value,
            cognome: document.getElementById('cognome').value,
            oreSettimanaliContratto: document.getElementById('oreSett').value,
            oreGiornaliereMax: document.getElementById('oreMax').value
        };

        // NOTA: Assumo che la tua API usi POST anche per update o abbia logica interna
        // Se hai PUT, cambia method in base alla presenza dell'ID
        const res = await fetch('/api/turni/dipendenti', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dip)
        });

        if(res.ok) {
            chiudiModals();
            caricaDipendenti();
        } else {
            alert("Errore salvataggio");
        }
    }

    // --- LOGICA ASSENZE ---
    function apriAssenze(id, cognome) {
        document.getElementById('assenzeDipId').value = id;
        document.getElementById('assenzeDipName').innerText = cognome;
        document.getElementById('modalAssenze').style.display = 'flex';
    }

    async function salvaAssenza() {
        const id = document.getElementById('assenzeDipId').value;
        const data = document.getElementById('dataAssenza').value;
        const tipo = document.getElementById('tipoAssenza').value;
        // const motivazione = document.getElementById('motivazione').value; // Se il backend la accetta, aggiungila all'URL o body

        if(!data) return alert("Inserisci la data");

        // Chiamata esistente
        await fetch(`/api/turni/assenza?dipendenteId=${id}&data=${data}&tipo=${tipo}`, { method: 'POST' });
        alert("Assenza registrata");
        chiudiModals();
    }

    function elimina(id) {
        if(confirm("Sei sicuro di voler eliminare questo dipendente?")) {
            // NOTA: Aggiungi endpoint DELETE se esiste, altrimenti:
            alert("Implementa endpoint DELETE nel backend per id: " + id);
            // await fetch('/api/turni/dipendenti/'+id, { method: 'DELETE' });
            // caricaDipendenti();
        }
    }

    function chiudiModals() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }

    // Avvio
    caricaDipendenti();
</script>

</body>
</html>