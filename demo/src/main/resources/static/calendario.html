<!--
    Questa pagina gestisce:
    - Visualizzazione delle settimane disponibili
    - Generazione automatica dei turni
    - Modifica manuale dei turni
    - Controllo di eventuali carenze di dipendenti per fascia oraria
    - Evidenziazione degi straordinari
-->
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SmartShift - Calendario</title>
    <link rel="stylesheet" href="style.css">
    <style>

        /* Stili per le SEGNALAZIONI VISIVE SUI TURNI */
        /* Straordinari */
        .shift-card.overtime {
            border: 2px solid #6f42c1;
            background-color: #f3e8ff;
        }
        .shift-card.overtime .shift-name {
            color: #59359a;
            font-weight: bold;
        }
        .badge-overtime {
            background-color: #6f42c1; color: white; font-size: 0.7em; padding: 2px 4px;
            border-radius: 4px; margin-left: 5px; vertical-align: middle;
        }
        /* Carenza di personale */
        .slot-missing {
            border: 2px dashed #dc3545; background-color: #fff5f5; color: #dc3545;
            padding: 8px; margin: 5px 0; border-radius: 6px; font-size: 0.85em; text-align: center;
        }

        /* Stili per i DIVISORI DELLE FASCE ORARIE */
        .slot-divider {
            background-color: #f8f9fa;
            color: #6c757d;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
            padding: 4px 8px;
            margin-top: 8px;
            margin-bottom: 4px;
            border-bottom: 2px solid #e9ecef;
            border-radius: 4px 4px 0 0;
            display: flex; align-items: center; gap: 5px;
        }
        .slot-empty-placeholder {
            font-size: 0.7em; color: #ddd; padding: 2px; text-align: center; font-style: italic;
        }

        /* Stili per la CONFIGURAZIONE DEI TURNI */
        /* Inserimento del numero minimo di dipendenti per fascia*/
        .config-row {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;
        }
        .config-row label { font-weight: bold; color: #495057; }
        .config-input {
            width: 60px; padding: 5px; border: 1px solid #ced4da; border-radius: 4px; text-align: center;
        }


        /* STILI GENERALI PER I TURNI */
        /* Card del turno*/
        .shift-card { position: relative; }
        /* Pulsante di eliminazione*/
        .btn-delete-shift {
            position: absolute; top: 2px; right: 2px; background: transparent; color: red;
            border: none; cursor: pointer; font-weight: bold; font-size: 14px;
        }
        /* Pulsante di aggunta di uno slot*/
        .btn-add-slot {
            width: 100%; background-color: #e9ecef; border: 1px dashed #adb5bd;
            color: #495057; padding: 5px; margin-top: 10px; cursor: pointer; border-radius: 4px;
        }
        
        /* Stili per HEADER E FILTRI */
        /* Layout intestazione */
        .modal-header-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;
        }
        .header-actions-right { display: flex; align-items: center; gap: 15px; }
        /* Select*/
        .select-modern {
            padding: 8px 12px; font-size: 14px; border: 1px solid #ced4da; border-radius: 6px;
            background-color: #fff; outline: none; transition: all 0.2s; cursor: pointer;
        }
        .select-modern:focus { border-color: #6f42c1; box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.15); }
        /* Pulsante chiusura */
        .close-styled { font-size: 28px; color: #aaa; cursor: pointer; line-height: 1; }
        .close-styled:hover { color: #333; }

    </style>
</head>
<body>

<!--
    BARRA DI NAVIGAZIONE
    Permette di navigare le varie sezioni
    -->
<div class="navbar">
    <a href="index.html">Home</a>
    <a href="calendario.html" class="active">Calendario</a>
    <a href="dipendenti.html">Gestione dipendenti</a>
</div>

<!--
    CONTENITORE DEL CALENDARIO
    -->
<div class="container">
    <!-- Titolo della pagina -->
    <h1>Pianificazione settimanale</h1>
    <!-- 
        Sezione che contiene le card delle settimane future con:
        - lo stato della settimana (Vuota / In corso / Pianificata)
        - i pulsanti azione (Vedi / Modifica / Genera)
    -->
    <div id="lista-settimane"></div>

    <!--
        MODALE PER LA VISUALIZZAZIONE DEI TURNI SETTIMANALI
        Mostra la griglia dei turni della settimana selezionata.
    -->
    <div id="modalTurni" class="modal">
        <div class="modal-content" style="width: 95%; max-width: 1400px; height: 90vh; display:flex; flex-direction:column;">
            <!-- Header del modale con titolo e filtro -->
            <div class="modal-header-row">
                <h2 id="modalTitle" style="margin:0;">Turni settimana</h2>
                <div class="header-actions-right">
                    <!-- Filtro dinamico dei dipendenti: 
                        aggiorna la visualizzazione senza ricaricare la pagina
                    -->
                    <select id="filtroDipendente" class="select-modern" onchange="aggiornaVistaTurni()">
                        <option value="">üîç Mostra tutti i dipendenti</option>
                    </select>
                    <!-- Pulsante di chiusura del modale -->
                    <span class="close-styled" onclick="chiudiModal('modalTurni')">&times;</span>
                </div>
            </div>
            <!-- 
                 Griglia calendario: contiene 7 colonne (giorni settimana)
                 suddivise in 4 fasce orarie ed evidenzia straordinari e carenze
            -->
            <div id="calendarGrid" class="calendar-grid" style="flex-grow:1; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- MODALE PER L'AGGIUNTA MANUALE DI UN TURNO -->
    <div id="modalAggiungi" class="modal" style="z-index: 1100;">
        <div class="modal-content" style="max-width: 400px;">
            <!-- Chiusura del modale -->
            <span class="close" onclick="chiudiModal('modalAggiungi')">&times;</span>
            <h3>Aggiungi turno</h3>
            <p>Giorno: <strong id="addDateLabel"></strong></p>
            <input type="hidden" id="addDateValue">
            <!-- Selezione del dipendente -->
            <label>Dipendente</label>
            <select id="selectDipendente" style="width:100%; padding:8px; margin-bottom:10px;"></select>
            <!-- Selezione dell'orario -->
            <label>Orario</label>
            <div style="display:flex; gap:10px;">
                <input type="time" id="addStart" value="09:00" style="flex:1;">
                <input type="time" id="addEnd" value="13:00" style="flex:1;">
            </div>
            <br>
            <!-- Bottone per confermare il salvataggio del turno -->
            <button class="btn-primary" onclick="salvaTurnoManuale()" style="width:100%;">Salva turno</button>
        </div>
    </div>

    <!-- MODALE PER LA CONFIGURAZIONE DELLA GENERAZIONE AUTOMATICA  -->
    <div id="modalConfigura" class="modal" style="z-index: 1200;">
        <div class="modal-content" style="max-width: 450px;">
            <!-- Chiusura del modale -->
            <span class="close" onclick="chiudiModal('modalConfigura')">&times;</span>
            <h3 style="color: #6f42c1;">‚öôÔ∏è Configura generazione</h3>
            <p>Imposta il numero <strong>minimo</strong> di dipendenti per fascia oraria.</p>
             <!-- Data di riferimento per la generazione -->
            <input type="hidden" id="configDateValue">
            
            <!-- Configurazione degli slot orari -->
            <div class="config-row">
                <label>Mattina (08:00 - 12:00)</label>
                <input type="number" id="confMattina" class="config-input" value="3" min="0">
            </div>
            <div class="config-row">
                <label>Pomeriggio (12:00 - 16:00)</label>
                <input type="number" id="confPomeriggio" class="config-input" value="4" min="0">
            </div>
            <div class="config-row">
                <label>Sera (16:00 - 20:00)</label>
                <input type="number" id="confSera" class="config-input" value="4" min="0">
            </div>
            <div class="config-row">
                <label>Notte (20:00 - 24:00)</label>
                <input type="number" id="confNotte" class="config-input" value="2" min="0">
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <!-- Pulsante di chiusura -->
                <button class="btn-secondary" onclick="chiudiModal('modalConfigura')">Annulla</button>
                <!-- Pulsante di conferma -->
                <button class="btn-primary" onclick="confermaGenerazione()">Genera turni</button>
            </div>
        </div>
    </div>
</div>

<script>
    // VARIABILI GLOBALI
    let tuttiITurni = [];
    let tuttiDipendenti = [];
    let tutteAssenze = [];
    let configSlot = []; 
    let viewState = { start: null, end: null, edit: false };

    // FUNZIONI DI UTILITA'
    // Converte una data nel formato YYYY-MM-DD
    function getYMD(dateInput) {
        if (!dateInput) return "";
        let d = (typeof dateInput === 'number' || (typeof dateInput === 'string' && /^\d+$/.test(dateInput))) 
            ? new Date(parseInt(dateInput)) : new Date(dateInput);
        if (isNaN(d.getTime())) return "";
        return d.toLocaleDateString('en-CA');
    }

    //  Calcola le prossime 5 settimane a partire dal luned√¨ corrente
    function getNextWeeks() {
        let weeks = [];
        let current = new Date();
        // Calcolo del luned√¨ della settimana corrente
        let day = current.getDay(); 
        let diff = current.getDate() - day + (day === 0 ? -6 : 1);
        let monday = new Date(current);
        monday.setDate(diff);
        for (let i = 0; i < 5; i++) {
            let start = new Date(monday);
            let end = new Date(monday);
            end.setDate(start.getDate() + 6);
            weeks.push({
                startStr: getYMD(start), endStr: getYMD(end),
                label: `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`
            });
            // Passa alla settimana successiva
            monday.setDate(monday.getDate() + 7);
        }
        return weeks;
    }

    // INIZIALIZZAZIONE DELLA PAGINA DEL CALENDARIO
    async function initCalendario() {
        try {
            // Chiama le API
            const [resTurni, resDip, resAss, resConf] = await Promise.all([
                fetch('/api/turni'), fetch('/api/turni/dipendenti'), fetch('/api/turni/assenze'), fetch('/api/turni/config-slot')
            ]);
            // Parsing delle ris√®pste
            if(resTurni.ok) tuttiITurni = await resTurni.json();
            if(resDip.ok) tuttiDipendenti = await resDip.json();
            if(resAss.ok) tutteAssenze = await resAss.json();
            if(resConf.ok) configSlot = await resConf.json();

            // Popolamento del filtro sui dipendenti
            const selectFiltro = document.getElementById('filtroDipendente');
            selectFiltro.innerHTML = '<option value="">üîç Mostra tutti i dipendenti</option>';
            tuttiDipendenti.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id; opt.innerText = `${d.nome} ${d.cognome}`; selectFiltro.appendChild(opt);
            });

            // Renderizza le settimane disponibii
            renderWeeks();
        } catch(e) { console.error("Errore API", e); }
    }

    // RENDER SETTIMANE FUTURE
    function renderWeeks() {
        const weeks = getNextWeeks();
        const container = document.getElementById('lista-settimane');
        container.innerHTML = '';
        
        weeks.forEach((week, index) => {
            // Controlla se esistono turni nella settimana
            const hasShifts = tuttiITurni.some(t => getYMD(t.data) >= week.startStr && getYMD(t.data) <= week.endStr);
            const div = document.createElement('div');
            div.className = `week-card ${hasShifts ? 'generated' : 'empty'}`;
            
            let buttonsHtml = '';
            if (hasShifts) {
                // Pulsante di visualizzazione
                buttonsHtml += `<button class="btn-primary" onclick="apriTurni('${week.startStr}', '${week.endStr}', false)">üëÅÔ∏è Vedi</button> `;
                // Pulsante di modifica
                buttonsHtml += `<button class="btn-secondary" onclick="apriTurni('${week.startStr}', '${week.endStr}', true)">‚úèÔ∏è Modifica</button> `;
                // Ricalcolo (possibile solo per settimane future)
                if (index > 0) {
                    buttonsHtml += `<button class="btn-warning" onclick="apriConfigurazioneGenerazione('${week.startStr}')">üîÑ Ricalcola</button>`;
                }
            } else {
                // Generazione iniziale della settimana
                buttonsHtml = `<button class="btn-success" onclick="apriConfigurazioneGenerazione('${week.startStr}')">Genera turni</button>`;
            }

            // Stato
            div.innerHTML = `
                <div>
                    <h3>Settimana ${week.label}</h3>
                    <span style="color:${hasShifts?'green':'red'}">
                        ${hasShifts ? (index === 0 ? 'In corso' : 'Pianificata') : 'Da pianificare'}
                    </span>
                </div>
                <div style="display:flex; gap:5px;">
                    ${buttonsHtml}
                </div>`;
            
            container.appendChild(div);
        });
    }

    // MODALE DI CONFIGURAZIONE E GENERAZIONE DEI TURNI
    function apriConfigurazioneGenerazione(dataStart) {
        document.getElementById('configDateValue').value = dataStart;
        document.getElementById('modalConfigura').style.display = 'flex';
    }

    /*
       Invio della richiesta POST al backend per generare i turni
       trasmettendo il numero minimo di dipendenti per ciascuna
       fascia oraria
    */
    async function confermaGenerazione() {
        const data = document.getElementById('configDateValue').value;
        const minM = document.getElementById('confMattina').value;
        const minP = document.getElementById('confPomeriggio').value;
        const minS = document.getElementById('confSera').value;
        const minN = document.getElementById('confNotte').value;

        if(!data || minM < 0 || minN < 0) { alert("Dati non validi"); return; }

        // Feedback visivo durante la generazione
        const btn = document.querySelector('#modalConfigura .btn-primary');
        const originalText = btn.innerText; btn.innerText = "Generazione..."; btn.disabled = true;
        
        try {
            // Invio dei parametri al backend
            const res = await fetch('/api/turni/genera', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    data, 
                    minMattina: parseInt(minM), 
                    minPomeriggio: parseInt(minP), 
                    minSera: parseInt(minS),
                    minNotte: parseInt(minN)
                })
            });
            if(res.ok) location.reload();
            else { alert("Errore generazione"); btn.innerText = originalText; btn.disabled = false; }
        } catch(e) { console.error(e); alert("Errore connessione"); btn.innerText = originalText; btn.disabled = false; }
    }

    // APERTURA E AGGIORNAMENTO DELLA GRIGLIA DEI TURNI
    // Aggiorna la vista mantenendo lo stato corrente
    function aggiornaVistaTurni() { if(viewState.start) apriTurni(viewState.start, viewState.end, viewState.edit); }

    // Apertura del modale per la settimana
    function apriTurni(startStr, endStr, isEditMode) {
        viewState = { start: startStr, end: endStr, edit: isEditMode };
        const modal = document.getElementById('modalTurni');
        const gridContainer = document.getElementById('calendarGrid');
        const modalTitle = document.getElementById('modalTitle');
        const idFiltro = document.getElementById('filtroDipendente').value;
        
        gridContainer.innerHTML = ''; 
        
        const dStart = new Date(startStr);
        const dEnd = new Date(endStr);
        const opts = { day: 'numeric', month: 'long', year: 'numeric' };
        
        const dataFormatted = `dal ${dStart.toLocaleDateString('it-IT', opts)} al ${dEnd.toLocaleDateString('it-IT', opts)}`;
        modalTitle.innerText = isEditMode ? `Modifica settimana ${dataFormatted}` : `Settimana ${dataFormatted}`;
        modalTitle.style.color = isEditMode ? "#d63384" : "#333";

        // Calcolo delle ore settimanali per dipendente
        let oreMap = {};
        tuttiDipendenti.forEach(d => oreMap[d.id] = 0);
        tuttiITurni.forEach(t => {
            if(getYMD(t.data) >= startStr && getYMD(t.data) <= endStr) {
                let hIn = parseInt(t.oraInizio.split(':')[0]), hOut = parseInt(t.oraFine.split(':')[0]);
                // Gestione turni notturni (terminano dopo mezzanotte)
                if(hOut < hIn) hOut += 24; 
                if(t.dipendente?.id) oreMap[t.dipendente.id] = (oreMap[t.dipendente.id] || 0) + (hOut - hIn);
            }
        });

        // MOSTRA SETTIMANA
        let currentDay = new Date(startStr);
        for (let i = 0; i < 7; i++) {
            const dateKey = getYMD(currentDay); 
            // Turni del giorno ordinati in base all'ora di inizio
            const turniDelGiorno = tuttiITurni.filter(t => getYMD(t.data) === dateKey);
            turniDelGiorno.sort((a,b) => a.oraInizio.localeCompare(b.oraInizio));

            // Controlla crenze di personale negli slot orari
            // verificando ora per ora che il niumereo minimo di dipendeni sia rispettato
            let warningHtml = '';
            if(configSlot.length > 0 && idFiltro === "") {
                configSlot.forEach(slot => {
                    let slotStart = parseInt(slot.inizio.split(':')[0]);
                    let slotEnd = parseInt(slot.fine.split(':')[0]);
                    // Gestione turni che terminano dopo mezzanotte
                    let calcEnd = (slotEnd < slotStart) ? slotEnd + 24 : slotEnd;
                    let oreScoperte = [];
                    // Ora per ora
                    for (let h = slotStart; h < calcEnd; h++) {
                        let currentHour = h % 24;
                        const attivi = turniDelGiorno.filter(t => {
                            let tIn = parseInt(t.oraInizio.split(':')[0]), tOut = parseInt(t.oraFine.split(':')[0]);
                            let tInNorm=tIn, tOutNorm=tOut;
                            // Per turni che terminano dopo mezzanotte
                            if(tOutNorm<tInNorm) tOutNorm+=24; 
                            if(tInNorm<slotStart && calcEnd>24) tInNorm+=24; if(tOutNorm<tInNorm) tOutNorm+=24; if(tOutNorm<slotStart && calcEnd>24) tOutNorm+=24;
                            return tInNorm <= h && tOutNorm > h;
                        }).length;
                        // Se il personale attivo √® inferiore al minimo richiesto
                        // seganala una carenza
                        if (attivi < slot.min) oreScoperte.push({h:currentHour, c:attivi});
                    }
                    // Unisce ore scoperte consecutive in intervalli
                    if (oreScoperte.length > 0) {
                        let ranges = []; 
                        let sB = oreScoperte[0].h, cB = oreScoperte[0].c, pH = sB;
                        for (let k=1; k<oreScoperte.length; k++) {
                            if((pH+1)%24 !== oreScoperte[k].h) { ranges.push({s:sB, e:(pH+1)%24, c:cB}); sB=oreScoperte[k].h; cB=oreScoperte[k].c; }
                            pH=oreScoperte[k].h;
                        }
                        ranges.push({s:sB, e:(pH+1)%24, c:cB});
                        ranges.forEach(r => {
                            warningHtml += `<div class="slot-missing">‚ö†Ô∏è <strong>${r.s.toString().padStart(2,'0')}:00-${r.e.toString().padStart(2,'0')}:00</strong> (${r.c}/${slot.min})</div>`;
                        });
                    }
                });
            }

            // DIVISORI DELL FASCE
            let htmlM='', htmlP='', htmlS='', htmlN='';
            let cM=0, cP=0, cS=0, cN=0;

            turniDelGiorno.forEach(t => {
                // Applica un filtro sui dipendenti, se attivo
                if(idFiltro !== "" && t.dipendente.id != idFiltro) return;
                const dip = tuttiDipendenti.find(d => d.id === t.dipendente.id);
                // Verifica se le ore sono straordinari (ore settimanali > contratto)
                let isOver = (dip && oreMap[dip.id] > dip.oreSettimanaliContratto);
                
                const card = `
                    <div class="shift-card ${isOver?'overtime':''} ${isEditMode?'edit-mode':''}">
                        ${isEditMode ? `<button class="btn-delete-shift" onclick="eliminaTurno(${t.id})">&times;</button>` : ''}
                        <div class="shift-name">üë§ ${t.dipendente.nome} ${t.dipendente.cognome.charAt(0)}. ${isOver?'<span class="badge-overtime">EXTRA</span>':''}</div>
                        <div class="shift-time">${t.oraInizio} - ${t.oraFine}</div>
                    </div>`;
                
                let hStart = parseInt(t.oraInizio.split(':')[0]);
                
                // Smistamento nelle 4 fasce
                if(hStart < 12) { htmlM+=card; cM++; }       // Fino alle 12 (Mattina)
                else if(hStart < 16) { htmlP+=card; cP++; }  // 12-16 (Pomeriggio)
                else if(hStart < 20) { htmlS+=card; cS++; }  // 16-20 (Sera)
                else { htmlN+=card; cN++; }                  // Dalle 20 in poi (Notte)
            });

            const emptyPl = `<div class="slot-empty-placeholder">-</div>`;
            let dailyBody = '';
            
            // Renderizzazione del giorno e dei suoi 4 slot orari
            dailyBody += `<div class="slot-divider">Mattina <small>(08-12)</small></div>` + (cM > 0 ? htmlM : emptyPl);
            dailyBody += `<div class="slot-divider">Pomeriggio <small>(12-16)</small></div>` + (cP > 0 ? htmlP : emptyPl);
            dailyBody += `<div class="slot-divider">Sera <small>(16-20)</small></div>` + (cS > 0 ? htmlS : emptyPl);
            dailyBody += `<div class="slot-divider">Notte <small>(20-24)</small></div>` + (cN > 0 ? htmlN : emptyPl);

            const addBtn = isEditMode ? `<button class="btn-add-slot" onclick="apriModalAggiungi('${dateKey}', '${startStr}', '${endStr}')">+ Aggiungi</button>` : '';
            const optsDay = { weekday: 'short', day: '2-digit', month: '2-digit' };

            gridContainer.innerHTML += `
                <div class="day-column">
                    <div class="day-header">${currentDay.toLocaleDateString('it-IT', optsDay)}</div>
                    <div class="day-body">${warningHtml}${dailyBody}${addBtn}</div>
                </div>`;
            currentDay.setDate(currentDay.getDate() + 1);
        }
        modal.style.display = 'flex';
    }

    // GESTIONE DELLA MODALE DI AGGIUNTA TURNO
    // Apertura della modale per una data specifica
    function apriModalAggiungi(dataTarget, weekStart, weekEnd) {
        document.getElementById('addDateValue').value = dataTarget;
        document.getElementById('addDateLabel').innerText = dataTarget;
        const select = document.getElementById('selectDipendente');
        select.innerHTML = '<option value="">-- Seleziona --</option>';

        tuttiDipendenti.forEach(d => {
            const option = document.createElement('option');
            option.value = d.id;
            
            // Verifica l'esistenza di assenze per la data in questione
            const assenza = tutteAssenze.find(a => (a.dipendente_id || a.dipendenteId || (a.dipendente && a.dipendente.id)) == d.id && getYMD(a.data) === dataTarget);
            // Disabilita dipendenti assenti nella data considerata
            if(assenza) {
                option.text = `‚õî ${d.nome} ${d.cognome} (${assenza.tipo})`;
                option.disabled = true; option.style.backgroundColor = "#ffe6e6"; select.appendChild(option); return;
            }

            // Calcola quante ore sono state  gi√† assegnate al dipendente nella settimana
            const turniSett = tuttiITurni.filter(t => t.dipendente.id == d.id && getYMD(t.data) >= weekStart && getYMD(t.data) <= weekEnd);
            let ore = turniSett.reduce((acc, t) => {
                let hI = parseInt(t.oraInizio.split(':')[0]), hO = parseInt(t.oraFine.split(':')[0]);
                return acc + ((hO < hI ? hO+24 : hO) - hI);
            }, 0);

            // Verifica se ad un dipendente √® gi√† stato assegnato un turno nel giorno considerato
            const inTurnoOggi = tuttiITurni.some(t => t.dipendente.id == d.id && getYMD(t.data) === dataTarget);
            let label = `${d.nome} ${d.cognome} (${ore}/${d.oreSettimanaliContratto}h)`;
            
            if(inTurnoOggi) { option.className = "impegnato"; label += " (Gi√† qui)"; }
            // Starordinario se (oreLavoarte >= oreContratto)
            else if(ore >= d.oreSettimanaliContratto) option.className = "straordinario";
            
            option.text = label;
            select.appendChild(option);
        });

        // Se √® attivo un filtro dipendente viene preselezionato
        if(document.getElementById('filtroDipendente').value) select.value = document.getElementById('filtroDipendente').value;
        document.getElementById('modalAggiungi').style.display = 'flex';
    }

    // Salvataggio di un turno inserito manualmente dall'utente
    async function salvaTurnoManuale() {
        const dipId = document.getElementById('selectDipendente').value;
        const dataSelezionata = document.getElementById('addDateValue').value; 
        const startInput = document.getElementById('addStart').value; 
        const endInput = document.getElementById('addEnd').value; 

        if(!dipId || !startInput || !endInput) return alert("Dati mancanti");

        // Conversione orari
        const [hIn, mIn] = startInput.split(':').map(Number);
        const [hOut, mOut] = endInput.split(':').map(Number);
        const minutiNuovoIn = hIn * 60 + mIn;
        let minutiNuovoOut = hOut * 60 + mOut;
        if (minutiNuovoOut <= minutiNuovoIn) minutiNuovoOut += 1440; // Oltre mezzanotte

        // Controlla eventuali sovrapposizioni con turni gi√† esistenti
        const collisione = tuttiITurni.find(t => {
            const stessoDip = (t.dipendente && t.dipendente.id == dipId);
            const stessoGiorno = (getYMD(t.data) === dataSelezionata);

            if (stessoDip && stessoGiorno) {
                let minutiEsistenteIn, minutiEsistenteOut;
                if (typeof t.oraInizio === 'number') {
                    minutiEsistenteIn = Math.round(t.oraInizio / 1000 / 60);
                    minutiEsistenteOut = Math.round(t.oraFine / 1000 / 60);
                } else {
                    const [ehIn, emIn] = t.oraInizio.split(':').map(Number);
                    const [ehOut, emOut] = t.oraFine.split(':').map(Number);
                    minutiEsistenteIn = ehIn * 60 + emIn;
                    minutiEsistenteOut = ehOut * 60 + emOut;
                }
                if (minutiEsistenteOut <= minutiEsistenteIn) minutiEsistenteOut += 1440;
                return (minutiNuovoIn < minutiEsistenteOut && minutiNuovoOut > minutiEsistenteIn);
            }
            return false;
        });

        if (collisione) return alert(`ERRORE: sovrapposizione di turni!`);

        // Salvataggio tramite API
        try {
            const res = await fetch('/api/turni/manuale', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ dipendenteId: parseInt(dipId), data: dataSelezionata, oraInizio: startInput, oraFine: endInput })
            });
            if(res.ok) location.reload(); 
            else { const err = await res.json(); alert("Errore: " + (err.error || "salvataggio fallito")); }
        } catch(e) { alert("Errore di connessione."); }
    }

    // Eliminazione di un turno tramite API
    async function eliminaTurno(id) {
        if(confirm("Eliminare?")) { await fetch(`/api/turni/${id}`, { method: 'DELETE' }); location.reload(); }
    }
    
    // Chiusura modale
    function chiudiModal(id) { document.getElementById(id).style.display = 'none'; }
    
    // INIZIALIZZAZIONE APPLICAZIONE
    // Avviamento del rendering del Calendario al caricamento della pagina
    initCalendario();
</script>
</body>
</html>