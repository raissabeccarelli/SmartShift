<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SmartShift - Calendario</title>
    <link rel="stylesheet" href="style.css">
    <style>

/* --- STILI PER LE SEGNALAZIONI --- */
        .shift-card.overtime {
            border: 2px solid #6f42c1;
            background-color: #f3e8ff;
        }
        .shift-card.overtime .shift-name {
            color: #59359a;
            font-weight: bold;
        }
        .badge-overtime {
            background-color: #6f42c1; color: white; font-size: 0.7em; padding: 2px 4px;
            border-radius: 4px; margin-left: 5px; vertical-align: middle;
        }
        .slot-missing {
            border: 2px dashed #dc3545; background-color: #fff5f5; color: #dc3545;
            padding: 8px; margin: 5px 0; border-radius: 6px; font-size: 0.85em; text-align: center;
        }

        /* --- NUOVO STILE DIVISORI FASCE --- */
        .slot-divider {
            background-color: #f8f9fa;
            color: #6c757d;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
            padding: 4px 8px;
            margin-top: 8px;
            margin-bottom: 4px;
            border-bottom: 2px solid #e9ecef;
            border-radius: 4px 4px 0 0;
            display: flex; align-items: center; gap: 5px;
        }
        .slot-empty-placeholder {
            font-size: 0.7em; color: #ddd; padding: 2px; text-align: center; font-style: italic;
        }

        /* --- INPUT NEL MODALE CONFIGURAZIONE --- */
        .config-row {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;
        }
        .config-row label { font-weight: bold; color: #495057; }
        .config-input {
            width: 60px; padding: 5px; border: 1px solid #ced4da; border-radius: 4px; text-align: center;
        }


        /* --- STILI GENERALI --- */
        .shift-card { position: relative; }
        .btn-delete-shift {
            position: absolute; top: 2px; right: 2px; background: transparent; color: red;
            border: none; cursor: pointer; font-weight: bold; font-size: 14px;
        }
        .btn-add-slot {
            width: 100%; background-color: #e9ecef; border: 1px dashed #adb5bd;
            color: #495057; padding: 5px; margin-top: 10px; cursor: pointer; border-radius: 4px;
        }
        
        /* HEADER E FILTRO */
        .modal-header-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;
        }
        .header-actions-right { display: flex; align-items: center; gap: 15px; }
        .select-modern {
            padding: 8px 12px; font-size: 14px; border: 1px solid #ced4da; border-radius: 6px;
            background-color: #fff; outline: none; transition: all 0.2s; cursor: pointer;
        }
        .select-modern:focus { border-color: #6f42c1; box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.15); }
        .close-styled { font-size: 28px; color: #aaa; cursor: pointer; line-height: 1; }
        .close-styled:hover { color: #333; }

    </style>
</head>
<body>

<div class="navbar">
    <a href="index.html">Home</a>
    <a href="calendario.html" class="active">Calendario</a>
    <a href="dipendenti.html">Gestione Dipendenti</a>
</div>

<div class="container">
    <h1>Pianificazione Settimanale</h1>
    <div id="lista-settimane"></div>

    <div id="modalTurni" class="modal">
        <div class="modal-content" style="width: 95%; max-width: 1400px; height: 90vh; display:flex; flex-direction:column;">
            <div class="modal-header-row">
                <h2 id="modalTitle" style="margin:0;">Turni Settimana</h2>
                <div class="header-actions-right">
                    <select id="filtroDipendente" class="select-modern" onchange="aggiornaVistaTurni()">
                        <option value="">üîç Mostra tutti i dipendenti</option>
                    </select>
                    <span class="close-styled" onclick="chiudiModal('modalTurni')">&times;</span>
                </div>
            </div>
            <div id="calendarGrid" class="calendar-grid" style="flex-grow:1; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="modalAggiungi" class="modal" style="z-index: 1100;">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="chiudiModal('modalAggiungi')">&times;</span>
            <h3>Aggiungi Turno</h3>
            <p>Giorno: <strong id="addDateLabel"></strong></p>
            <input type="hidden" id="addDateValue">
            <label>Dipendente</label>
            <select id="selectDipendente" style="width:100%; padding:8px; margin-bottom:10px;"></select>
            <label>Orario</label>
            <div style="display:flex; gap:10px;">
                <input type="time" id="addStart" value="09:00" style="flex:1;">
                <input type="time" id="addEnd" value="13:00" style="flex:1;">
            </div>
            <br>
            <button class="btn-primary" onclick="salvaTurnoManuale()" style="width:100%;">Salva Turno</button>
        </div>
    </div>

    <div id="modalConfigura" class="modal" style="z-index: 1200;">
        <div class="modal-content" style="max-width: 450px;">
            <span class="close" onclick="chiudiModal('modalConfigura')">&times;</span>
            <h3 style="color: #6f42c1;">‚öôÔ∏è Configura Generazione</h3>
            <p>Imposta il numero <strong>minimo</strong> di dipendenti per fascia oraria.</p>
            <input type="hidden" id="configDateValue">
            <div class="config-row">
                <label>Mattina (06:00 - 12:00)</label>
                <input type="number" id="confMattina" class="config-input" value="3" min="0">
            </div>
            <div class="config-row">
                <label>Pomeriggio (12:00 - 18:00)</label>
                <input type="number" id="confPomeriggio" class="config-input" value="4" min="0">
            </div>
            <div class="config-row">
                <label>Sera (18:00 - 23:00)</label>
                <input type="number" id="confSera" class="config-input" value="5" min="0">
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn-secondary" onclick="chiudiModal('modalConfigura')">Annulla</button>
                <button class="btn-primary" onclick="confermaGenerazione()">Genera Turni</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- VARIABILI GLOBALI ---
    let tuttiITurni = [];
    let tuttiDipendenti = [];
    let tutteAssenze = [];
    let configSlot = []; // Carenze di default
    let viewState = { start: null, end: null, edit: false };

    // FUNZIONI UTILITA
    function getYMD(dateInput) {
        if (!dateInput) return "";
        let d = (typeof dateInput === 'number' || (typeof dateInput === 'string' && /^\d+$/.test(dateInput))) 
            ? new Date(parseInt(dateInput)) : new Date(dateInput);
        if (isNaN(d.getTime())) return "";
        return d.toLocaleDateString('en-CA');
    }

    function getNextWeeks() {
        let weeks = [];
        let current = new Date();
        let day = current.getDay(); 
        let diff = current.getDate() - day + (day === 0 ? -6 : 1);
        let monday = new Date(current);
        monday.setDate(diff);
        for (let i = 0; i < 5; i++) {
            let start = new Date(monday);
            let end = new Date(monday);
            end.setDate(start.getDate() + 6);
            weeks.push({
                startStr: getYMD(start), endStr: getYMD(end),
                label: `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`
            });
            monday.setDate(monday.getDate() + 7);
        }
        return weeks;
    }

    // --- INIT ---
    async function initCalendario() {
        try {
            const [resTurni, resDip, resAss, resConf] = await Promise.all([
                fetch('/api/turni'), fetch('/api/turni/dipendenti'), fetch('/api/turni/assenze'), fetch('/api/turni/config-slot')
            ]);
            if(resTurni.ok) tuttiITurni = await resTurni.json();
            if(resDip.ok) tuttiDipendenti = await resDip.json();
            if(resAss.ok) tutteAssenze = await resAss.json();
            if(resConf.ok) configSlot = await resConf.json();

            const selectFiltro = document.getElementById('filtroDipendente');
            selectFiltro.innerHTML = '<option value="">üîç Mostra tutti i dipendenti</option>';
            tuttiDipendenti.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id; opt.innerText = `${d.nome} ${d.cognome}`; selectFiltro.appendChild(opt);
            });

            renderWeeks();
        } catch(e) { console.error("Errore API", e); }
    }

    function renderWeeks() {
        const weeks = getNextWeeks();
        const container = document.getElementById('lista-settimane');
        container.innerHTML = '';
        weeks.forEach(week => {
            const hasShifts = tuttiITurni.some(t => getYMD(t.data) >= week.startStr && getYMD(t.data) <= week.endStr);
            const div = document.createElement('div');
            div.className = `week-card ${hasShifts ? 'generated' : 'empty'}`;
            let buttonsHtml = hasShifts ? `
                <button class="btn-primary" onclick="apriTurni('${week.startStr}', '${week.endStr}', false)">üëÅÔ∏è Vedi</button>
                <button class="btn-secondary" onclick="apriTurni('${week.startStr}', '${week.endStr}', true)">‚úèÔ∏è Modifica</button>
                <button class="btn-warning" onclick="apriConfigurazioneGenerazione('${week.startStr}')">üîÑ Ricalcola</button>
            ` : `<button class="btn-success" onclick="apriConfigurazioneGenerazione('${week.startStr}')">Genera Turni</button>`;
            div.innerHTML = `<div><h3>Settimana ${week.label}</h3><span style="color:${hasShifts?'green':'red'}">${hasShifts?'Pianificata':'Da Pianificare'}</span></div><div style="display:flex;gap:5px;">${buttonsHtml}</div>`;
            container.appendChild(div);
        });
    }

    // --- LOGICA MODALE GENERAZIONE ---
    function apriConfigurazioneGenerazione(dataStart) {
        document.getElementById('configDateValue').value = dataStart;
        document.getElementById('modalConfigura').style.display = 'flex';
    }
    async function confermaGenerazione() {
        const data = document.getElementById('configDateValue').value;
        const minM = document.getElementById('confMattina').value;
        const minP = document.getElementById('confPomeriggio').value;
        const minS = document.getElementById('confSera').value;
        if(!data || minM < 0) { alert("Dati non validi"); return; }

        const btn = document.querySelector('#modalConfigura .btn-primary');
        const originalText = btn.innerText; btn.innerText = "Generazione..."; btn.disabled = true;
        
        try {
            const res = await fetch('/api/turni/genera', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data, minMattina: parseInt(minM), minPomeriggio: parseInt(minP), minSera: parseInt(minS) })
            });
            if(res.ok) location.reload();
            else { alert("Errore generazione"); btn.innerText = originalText; btn.disabled = false; }
        } catch(e) { console.error(e); alert("Errore connessione"); btn.innerText = originalText; btn.disabled = false; }
    }

    // --- LOGICA GRIGLIA TURNI CON DIVISORI ---
    function aggiornaVistaTurni() { if(viewState.start) apriTurni(viewState.start, viewState.end, viewState.edit); }

    function apriTurni(startStr, endStr, isEditMode) {
        viewState = { start: startStr, end: endStr, edit: isEditMode };
        const modal = document.getElementById('modalTurni');
        const gridContainer = document.getElementById('calendarGrid');
        const modalTitle = document.getElementById('modalTitle');
        const idFiltro = document.getElementById('filtroDipendente').value;
        
        gridContainer.innerHTML = ''; 
        
        // --- MODIFICA LOGICA TITOLO ---
        const dStart = new Date(startStr);
        const dEnd = new Date(endStr);
        const opts = { day: 'numeric', month: 'long', year: 'numeric' };
        
        const dataFormatted = `dal ${dStart.toLocaleDateString('it-IT', opts)} al ${dEnd.toLocaleDateString('it-IT', opts)}`;
        
        if (isEditMode) {
            modalTitle.innerText = `Modifica settimana ${dataFormatted}`;
            modalTitle.style.color = "#d63384"; // Colore magenta per edit
        } else {
            modalTitle.innerText = `Settimana ${dataFormatted}`;
            modalTitle.style.color = "#333"; // Colore standard
        }
        // ------------------------------

        let oreMap = {};
        tuttiDipendenti.forEach(d => oreMap[d.id] = 0);
        tuttiITurni.forEach(t => {
            if(getYMD(t.data) >= startStr && getYMD(t.data) <= endStr) {
                let hIn = parseInt(t.oraInizio.split(':')[0]), hOut = parseInt(t.oraFine.split(':')[0]);
                if(hOut < hIn) hOut += 24; 
                if(t.dipendente?.id) oreMap[t.dipendente.id] = (oreMap[t.dipendente.id] || 0) + (hOut - hIn);
            }
        });

        let currentDay = new Date(startStr);
        for (let i = 0; i < 7; i++) {
            const dateKey = getYMD(currentDay); 
            const turniDelGiorno = tuttiITurni.filter(t => getYMD(t.data) === dateKey);
            turniDelGiorno.sort((a,b) => a.oraInizio.localeCompare(b.oraInizio));

            // -- CARENZE (Mostriamo solo se non c'√® filtro attivo) --
            let warningHtml = '';
            if(configSlot.length > 0 && idFiltro === "") {
                configSlot.forEach(slot => {
                    let slotStart = parseInt(slot.inizio.split(':')[0]);
                    let slotEnd = parseInt(slot.fine.split(':')[0]);
                    let calcEnd = (slotEnd < slotStart) ? slotEnd + 24 : slotEnd;
                    let oreScoperte = [];
                    for (let h = slotStart; h < calcEnd; h++) {
                        let currentHour = h % 24;
                        const attivi = turniDelGiorno.filter(t => {
                            let tIn = parseInt(t.oraInizio.split(':')[0]), tOut = parseInt(t.oraFine.split(':')[0]);
                            let tInNorm=tIn, tOutNorm=tOut;
                            if(tOutNorm<tInNorm) tOutNorm+=24; 
                            if(tInNorm<slotStart && calcEnd>24) tInNorm+=24; if(tOutNorm<tInNorm) tOutNorm+=24; if(tOutNorm<slotStart && calcEnd>24) tOutNorm+=24;
                            return tInNorm <= h && tOutNorm > h;
                        }).length;
                        if (attivi < slot.min) oreScoperte.push({h:currentHour, c:attivi});
                    }
                    if (oreScoperte.length > 0) {
                         // Raggruppa ore contigue
                        let ranges = []; 
                        let sB = oreScoperte[0].h, cB = oreScoperte[0].c, pH = sB;
                        for (let k=1; k<oreScoperte.length; k++) {
                            if((pH+1)%24 !== oreScoperte[k].h) { ranges.push({s:sB, e:(pH+1)%24, c:cB}); sB=oreScoperte[k].h; cB=oreScoperte[k].c; }
                            pH=oreScoperte[k].h;
                        }
                        ranges.push({s:sB, e:(pH+1)%24, c:cB});
                        ranges.forEach(r => {
                            warningHtml += `<div class="slot-missing">‚ö†Ô∏è <strong>${r.s.toString().padStart(2,'0')}:00-${r.e.toString().padStart(2,'0')}:00</strong> (${r.c}/${slot.min})</div>`;
                        });
                    }
                });
            }

            // -- DIVISORI FASCE E CARDS --
            let htmlM='', htmlP='', htmlS='';
            let cM=0, cP=0, cS=0;

            turniDelGiorno.forEach(t => {
                if(idFiltro !== "" && t.dipendente.id != idFiltro) return;
                const dip = tuttiDipendenti.find(d => d.id === t.dipendente.id);
                let isOver = (dip && oreMap[dip.id] > dip.oreSettimanaliContratto);
                
                const card = `
                    <div class="shift-card ${isOver?'overtime':''} ${isEditMode?'edit-mode':''}">
                        ${isEditMode ? `<button class="btn-delete-shift" onclick="eliminaTurno(${t.id})">&times;</button>` : ''}
                        <div class="shift-name">üë§ ${t.dipendente.nome} ${t.dipendente.cognome.charAt(0)}. ${isOver?'<span class="badge-overtime">EXTRA</span>':''}</div>
                        <div class="shift-time">${t.oraInizio} - ${t.oraFine}</div>
                    </div>`;
                
                let hStart = parseInt(t.oraInizio.split(':')[0]);
                if(hStart < 12) { htmlM+=card; cM++; }
                else if(hStart < 18) { htmlP+=card; cP++; }
                else { htmlS+=card; cS++; }
            });

            const emptyPl = `<div class="slot-empty-placeholder">-</div>`;
            let dailyBody = '';
            
            // Renderizziamo sempre le fasce per struttura
            dailyBody += `<div class="slot-divider">Mattina <small>(06-12)</small></div>` + (cM > 0 ? htmlM : emptyPl);
            dailyBody += `<div class="slot-divider">Pomeriggio <small>(12-18)</small></div>` + (cP > 0 ? htmlP : emptyPl);
            dailyBody += `<div class="slot-divider">Sera <small>(18-23)</small></div>` + (cS > 0 ? htmlS : emptyPl);

            const addBtn = isEditMode ? `<button class="btn-add-slot" onclick="apriModalAggiungi('${dateKey}', '${startStr}', '${endStr}')">+ Aggiungi</button>` : '';
            const opts = { weekday: 'short', day: '2-digit', month: '2-digit' };

            gridContainer.innerHTML += `
                <div class="day-column">
                    <div class="day-header">${currentDay.toLocaleDateString('it-IT', opts)}</div>
                    <div class="day-body">${warningHtml}${dailyBody}${addBtn}</div>
                </div>`;
            currentDay.setDate(currentDay.getDate() + 1);
        }
        modal.style.display = 'flex';
    }

    function apriModalAggiungi(dataTarget, weekStart, weekEnd) {
        document.getElementById('addDateValue').value = dataTarget;
        document.getElementById('addDateLabel').innerText = dataTarget;
        const select = document.getElementById('selectDipendente');
        select.innerHTML = '<option value="">-- Seleziona --</option>';

        tuttiDipendenti.forEach(d => {
            const option = document.createElement('option');
            option.value = d.id;
            
            const assenza = tutteAssenze.find(a => (a.dipendente_id || a.dipendenteId || (a.dipendente && a.dipendente.id)) == d.id && getYMD(a.data) === dataTarget);
            if(assenza) {
                option.text = `‚õî ${d.nome} ${d.cognome} (${assenza.tipo})`;
                option.disabled = true; option.style.backgroundColor = "#ffe6e6"; select.appendChild(option); return;
            }

            const turniSett = tuttiITurni.filter(t => t.dipendente.id == d.id && getYMD(t.data) >= weekStart && getYMD(t.data) <= weekEnd);
            let ore = turniSett.reduce((acc, t) => {
                let hI = parseInt(t.oraInizio.split(':')[0]), hO = parseInt(t.oraFine.split(':')[0]);
                return acc + ((hO < hI ? hO+24 : hO) - hI);
            }, 0);

            const inTurnoOggi = tuttiITurni.some(t => t.dipendente.id == d.id && getYMD(t.data) === dataTarget);
            let label = `${d.nome} ${d.cognome} (${ore}/${d.oreSettimanaliContratto}h)`;
            
            if(inTurnoOggi) { option.className = "impegnato"; label += " (Gi√† qui)"; }
            else if(ore >= d.oreSettimanaliContratto) option.className = "straordinario";
            
            option.text = label;
            select.appendChild(option);
        });

        if(document.getElementById('filtroDipendente').value) select.value = document.getElementById('filtroDipendente').value;
        document.getElementById('modalAggiungi').style.display = 'flex';
    }

   async function salvaTurnoManuale() {
    const dipId = document.getElementById('selectDipendente').value;
    const dataSelezionata = document.getElementById('addDateValue').value; // Es: "2026-02-14"
    const startInput = document.getElementById('addStart').value;         // Es: "06:00"
    const endInput = document.getElementById('addEnd').value;             // Es: "08:00"

    if(!dipId || !startInput || !endInput) return alert("Dati mancanti");

    // 1. Convertiamo l'input del modale in minuti totali della giornata
    const [hIn, mIn] = startInput.split(':').map(Number);
    const [hOut, mOut] = endInput.split(':').map(Number);
    const minutiNuovoIn = hIn * 60 + mIn;
    let minutiNuovoOut = hOut * 60 + mOut;
    
    // Gestione turno che scavalca la mezzanotte (es. 22:00 - 02:00)
    if (minutiNuovoOut <= minutiNuovoIn) minutiNuovoOut += 1440;

    // 2. Cerchiamo sovrapposizioni nei turni esistenti
    const collisione = tuttiITurni.find(t => {
        // Filtro per lo stesso dipendente
        const stessoDip = (t.dipendente && t.dipendente.id == dipId);
        // Filtro per lo stesso giorno (usando la tua funzione getYMD)
        const stessoGiorno = (getYMD(t.data) === dataSelezionata);

        if (stessoDip && stessoGiorno) {
            let minutiEsistenteIn, minutiEsistenteOut;

            // RILEVANTE: Controlliamo se l'ora √® un numero (millisecondi) o una stringa "HH:mm"
            if (typeof t.oraInizio === 'number') {
                minutiEsistenteIn = Math.round(t.oraInizio / 1000 / 60);
                minutiEsistenteOut = Math.round(t.oraFine / 1000 / 60);
            } else {
                const [ehIn, emIn] = t.oraInizio.split(':').map(Number);
                const [ehOut, emOut] = t.oraFine.split(':').map(Number);
                minutiEsistenteIn = ehIn * 60 + emIn;
                minutiEsistenteOut = ehOut * 60 + emOut;
            }

            if (minutiEsistenteOut <= minutiEsistenteIn) minutiEsistenteOut += 1440;

            // Formula universale di sovrapposizione:
            // (Inizio1 < Fine2) E (Fine1 > Inizio2)
            return (minutiNuovoIn < minutiEsistenteOut && minutiNuovoOut > minutiEsistenteIn);
        }
        return false;
    });

    if (collisione) {
        return alert(`ERRORE: Non puoi assegnare ad un dipendente un orario in cui gi√† lavora!`);
    }

    // 3. Invio al server se non ci sono collisioni
    try {
        const res = await fetch('/api/turni/manuale', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                dipendenteId: parseInt(dipId), 
                data: dataSelezionata, 
                oraInizio: startInput, 
                oraFine: endInput 
            })
        });
        if(res.ok) {
            location.reload(); 
        } else {
            const err = await res.json();
            alert("Errore: " + (err.error || "Salvataggio fallito"));
        }
    } catch(e) { 
        alert("Errore di connessione al database."); 
    }
}

    async function eliminaTurno(id) {
        if(confirm("Eliminare?")) { await fetch(`/api/turni/${id}`, { method: 'DELETE' }); location.reload(); }
    }
    
    function chiudiModal(id) { document.getElementById(id).style.display = 'none'; }
    initCalendario();
</script>
</body>
</html>