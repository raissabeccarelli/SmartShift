<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SmartShift - Calendario</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- STILI PER LE SEGNALAZIONI --- */
        .shift-card.overtime {
            border: 2px solid #6f42c1;
            background-color: #f3e8ff;
        }
        .shift-card.overtime .shift-name {
            color: #59359a;
            font-weight: bold;
        }
        .badge-overtime {
            background-color: #6f42c1;
            color: white; 
            font-size: 0.7em; 
            padding: 2px 4px;
            border-radius: 4px; 
            margin-left: 5px; 
            vertical-align: middle;
        }

        .slot-missing {
            border: 2px dashed #dc3545;
            background-color: #fff5f5;
            color: #dc3545;
            padding: 8px; 
            margin: 5px 0;
            border-radius: 6px; 
            font-size: 0.85em; 
            text-align: center;
        }
        .slot-missing strong { 
            display: block; 
            font-size: 1.1em; 
            margin-bottom: 2px;
        }

        /* --- STILI GENERALI --- */
        .shift-card { position: relative; }
        
        .btn-delete-shift {
            position: absolute; top: 2px; right: 2px;
            background: transparent; color: red; border: none;
            cursor: pointer; font-weight: bold; font-size: 14px;
        }
        .btn-delete-shift:hover { background: #ffe6e6; border-radius: 50%; }
        
        .btn-add-slot {
            width: 100%; background-color: #e9ecef; border: 1px dashed #adb5bd;
            color: #495057; padding: 5px; margin-top: 10px; cursor: pointer; border-radius: 4px;
        }
        .btn-add-slot:hover { background-color: #dde2e6; }
        
        option.straordinario { color: #d63384; font-weight: bold; }
        option.impegnato { background-color: #fff3cd; color: #856404; } 
    </style>
</head>
<body>

<div class="navbar">
    <a href="index.html">Home</a>
    <a href="calendario.html" class="active">Calendario</a>
    <a href="dipendenti.html">Gestione Dipendenti</a>
</div>

<div class="container">
    <h1>Pianificazione Settimanale</h1>
    
    <div style="margin-bottom: 15px;">
        <span style="display:inline-block; width:15px; height:15px; background:#f3e8ff; border:1px solid #6f42c1; vertical-align:middle; margin-right:5px;"></span> Straordinario
        <span style="display:inline-block; width:15px; height:15px; background:#fff5f5; border:1px dashed #dc3545; vertical-align:middle; margin-left:15px; margin-right:5px;"></span> Sotto-organico (Carenza)
    </div>
    
    <div id="lista-settimane"></div>

    <div id="modalTurni" class="modal">
        <div class="modal-content" style="width: 95%; max-width: 1400px; height: 90vh; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 id="modalTitle" style="margin:0;">Turni Settimana</h2>
                <span class="close" onclick="chiudiModal('modalTurni')" style="font-size:30px;">&times;</span>
            </div>
            <div id="calendarGrid" class="calendar-grid" style="flex-grow:1; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="modalAggiungi" class="modal" style="z-index: 1100;">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="chiudiModal('modalAggiungi')">&times;</span>
            <h3>Aggiungi Turno</h3>
            <p>Giorno: <strong id="addDateLabel"></strong></p>
            <input type="hidden" id="addDateValue">

            <label>Dipendente</label>
            <select id="selectDipendente" style="width:100%; padding:8px; margin-bottom:10px;"></select>

            <label>Orario</label>
            <div style="display:flex; gap:10px;">
                <input type="time" id="addStart" value="09:00" style="flex:1;">
                <input type="time" id="addEnd" value="13:00" style="flex:1;">
            </div>
            <br>
            <button class="btn-primary" onclick="salvaTurnoManuale()" style="width:100%;">Salva Turno</button>
        </div>
    </div>
</div>

<script>
    // --- VARIABILI GLOBALI ---
    let tuttiITurni = [];
    let tuttiDipendenti = [];
    let tutteAssenze = [];
    let configSlot = [];

    // --- CALCOLO DATE SETTIMANE ---
    function getNextWeeks() {
        let weeks = [];
        let current = new Date();
        let day = current.getDay();
        let diff = current.getDate() - day + (day == 0 ? -6 : 1);
        current.setDate(diff);

        for (let i = 0; i < 5; i++) {
            let start = new Date(current);
            let end = new Date(current);
            end.setDate(start.getDate() + 6);
            weeks.push({
                startStr: start.toISOString().split('T')[0],
                endStr: end.toISOString().split('T')[0],
                label: `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`
            });
            current.setDate(current.getDate() + 7);
        }
        return weeks;
    }

    // --- INIZIALIZZAZIONE ---
    async function initCalendario() {
        try {
            const [resTurni, resDip, resAss, resConf] = await Promise.all([
                fetch('/api/turni', { method: 'GET' }),
                fetch('/api/turni/dipendenti', { method: 'GET' }),
                fetch('/api/turni/assenze', { method: 'GET' }),
                fetch('/api/turni/config-slot', { method: 'GET' }) 
            ]);

            if(resTurni.ok) tuttiITurni = await resTurni.json();
            if(resDip.ok) tuttiDipendenti = await resDip.json();
            if(resAss.ok) tutteAssenze = await resAss.json();
            if(resConf.ok) configSlot = await resConf.json(); 

        } catch(e) { console.error("Errore API", e); }
        renderWeeks();
    }

    // --- RENDER LISTA SETTIMANE ---
    function renderWeeks() {
        const weeks = getNextWeeks();
        const container = document.getElementById('lista-settimane');
        container.innerHTML = '';

        weeks.forEach(week => {
            const hasShifts = tuttiITurni.some(t => t.data >= week.startStr && t.data <= week.endStr);
            const div = document.createElement('div');
            div.className = `week-card ${hasShifts ? 'generated' : 'empty'}`;
            
            let buttonsHtml = hasShifts ? `
                <button class="btn-primary" onclick="apriTurni('${week.startStr}', '${week.endStr}', false)">üëÅÔ∏è Vedi</button>
                <button class="btn-secondary" onclick="apriTurni('${week.startStr}', '${week.endStr}', true)">‚úèÔ∏è Modifica</button>
                <button class="btn-warning" onclick="ricalcolaTurni('${week.startStr}')">üîÑ Ricalcola</button>
            ` : `<button class="btn-success" onclick="generaTurni('${week.startStr}')">‚ö° Genera Turni</button>`;

            div.innerHTML = `
                <div>
                    <h3>Settimana ${week.label}</h3>
                    <span style="color: ${hasShifts ? 'green' : 'red'}">
                        ${hasShifts ? '‚úÖ Pianificata' : '‚ö†Ô∏è Da Pianificare'}
                    </span>
                </div>
                <div style="display:flex; gap:5px;">${buttonsHtml}</div>
            `;
            container.appendChild(div);
        });
    }

    // --- LOGICA PRINCIPALE ---
    function apriTurni(startStr, endStr, isEditMode) {
        const modal = document.getElementById('modalTurni');
        const gridContainer = document.getElementById('calendarGrid');
        const modalTitle = document.getElementById('modalTitle');
        
        gridContainer.innerHTML = ''; 
        modalTitle.innerText = (isEditMode ? "MODIFICA: " : "VISTA: ") + `${startStr}`;
        modalTitle.style.color = isEditMode ? "#d63384" : "#333";

        // Mappa Ore Totali
        let oreSettimanaliMap = {};
        tuttiDipendenti.forEach(d => oreSettimanaliMap[d.id] = 0);

        tuttiITurni.forEach(t => {
            if(t.data >= startStr && t.data <= endStr) {
                let hIn = parseInt(t.oraInizio.split(':')[0]);
                let hOut = parseInt(t.oraFine.split(':')[0]);
                if(hOut < hIn) hOut += 24; 
                if(t.dipendente && t.dipendente.id) {
                    oreSettimanaliMap[t.dipendente.id] = (oreSettimanaliMap[t.dipendente.id] || 0) + (hOut - hIn);
                }
            }
        });

        let currentDay = new Date(startStr);
        for (let i = 0; i < 7; i++) {
            const dateKey = currentDay.toISOString().split('T')[0];
            const turniDelGiorno = tuttiITurni.filter(t => t.data === dateKey);
            turniDelGiorno.sort((a,b) => a.oraInizio.localeCompare(b.oraInizio));

            // A. CARENZE
            let warningHtml = '';
            if(configSlot.length > 0) {
                configSlot.forEach(slot => {
                    let slotStart = parseInt(slot.inizio.split(':')[0]);
                    let slotEnd = parseInt(slot.fine.split(':')[0]);
                    let calcEnd = (slotEnd < slotStart) ? slotEnd + 24 : slotEnd;
                    let oreScoperte = [];

                    for (let h = slotStart; h < calcEnd; h++) {
                        let currentHour = h % 24;
                        const attiviInQuestOra = turniDelGiorno.filter(t => {
                            let tIn = parseInt(t.oraInizio.split(':')[0]);
                            let tOut = parseInt(t.oraFine.split(':')[0]);
                            let tInNorm = tIn;
                            let tOutNorm = tOut;
                            if (tOutNorm < tInNorm) tOutNorm += 24;
                            if (tInNorm < slotStart && calcEnd > 24) tInNorm += 24;
                            if (tOutNorm < tInNorm) tOutNorm += 24; 
                            if (tOutNorm < slotStart && calcEnd > 24) tOutNorm += 24;
                            return tInNorm <= h && tOutNorm > h;
                        }).length;

                        if (attiviInQuestOra < slot.min) oreScoperte.push({ hour: currentHour, count: attiviInQuestOra });
                    }

                    if (oreScoperte.length > 0) {
                        let ranges = [];
                        let startBlock = oreScoperte[0].hour;
                        let countBlock = oreScoperte[0].count;
                        let prevHour = startBlock;

                        for (let i = 1; i < oreScoperte.length; i++) {
                            let curr = oreScoperte[i];
                            if ((prevHour + 1) % 24 !== curr.hour) {
                                ranges.push({start: startBlock, end: (prevHour + 1) % 24, count: countBlock});
                                startBlock = curr.hour;
                                countBlock = curr.count;
                            }
                            prevHour = curr.hour;
                        }
                        ranges.push({start: startBlock, end: (prevHour + 1) % 24, count: countBlock});

                        ranges.forEach(r => {
                            let sStr = r.start.toString().padStart(2, '0') + ":00";
                            let eStr = r.end.toString().padStart(2, '0') + ":00";
                            warningHtml += `<div class="slot-missing"><strong>‚ö†Ô∏è Carenza: ${sStr} - ${eStr}</strong>Personale: ${r.count} / ${slot.min}</div>`;
                        });
                    }
                });
            }

            // B. Card Turni
            let cardsHtml = '';
            turniDelGiorno.forEach(t => {
                const dip = tuttiDipendenti.find(d => d.id === t.dipendente.id);
                let isOvertime = false;
                if(dip && oreSettimanaliMap[dip.id] > dip.oreSettimanaliContratto) isOvertime = true;

                const deleteBtn = isEditMode 
                    ? `<button class="btn-delete-shift" onclick="eliminaTurno(${t.id})" title="Elimina">&times;</button>` : '';
                
                const overtimeClass = isOvertime ? 'overtime' : '';
                const overtimeBadge = isOvertime ? '<span class="badge-overtime">EXTRA</span>' : '';

                cardsHtml += `
                    <div class="shift-card ${overtimeClass} ${isEditMode ? 'edit-mode' : ''}">
                        ${deleteBtn}
                        <div class="shift-name">üë§ ${t.dipendente.nome} ${t.dipendente.cognome.charAt(0)}. ${overtimeBadge}</div>
                        <div class="shift-time">‚è∞ ${t.oraInizio} - ${t.oraFine}</div>
                    </div>
                `;
            });

            // C. Costruzione
            const addBtn = isEditMode 
                ? `<button class="btn-add-slot" onclick="apriModalAggiungi('${dateKey}', '${startStr}', '${endStr}')">+ Aggiungi</button>` : '';

            const options = { weekday: 'short', day: '2-digit', month: '2-digit' };
            const labelData = currentDay.toLocaleDateString('it-IT', options);

            gridContainer.innerHTML += `
                <div class="day-column">
                    <div class="day-header">${labelData}</div>
                    <div class="day-body">${warningHtml}${cardsHtml}${addBtn}</div>
                </div>`;
            currentDay.setDate(currentDay.getDate() + 1);
        }
        modal.style.display = 'flex';
    }

    // --- HELPER TEMPO ---
    function timeToMinutes(str) {
        if(!str) return 0;
        const [h, m] = str.split(':').map(Number);
        return h * 60 + m;
    }

    // --- FUNZIONI DI MODIFICA/SALVATAGGIO ---

    function apriModalAggiungi(dataTarget, weekStart, weekEnd) {
        try {
            document.getElementById('addDateValue').value = dataTarget;
            document.getElementById('addDateLabel').innerText = dataTarget;
            const select = document.getElementById('selectDipendente');
            select.innerHTML = '<option value="">-- Seleziona --</option>';

            // LOG PER DEBUG: Premi F12 in console per vederlo
            console.log("--- DEBUG APRI MODAL ---");
            console.log("Data Target (Click):", dataTarget);

            // Filtro ID assenti
            const idAssentiOggi = tutteAssenze.filter(a => {
                if (!a.dipendente) return false;

                // FIX DATE: Trasformiamo tutto in stringa ed estraiamo solo YYYY-MM-DD
                let dataAssenzaStr = String(a.data);
                if (dataAssenzaStr.includes('T')) {
                    dataAssenzaStr = dataAssenzaStr.split('T')[0];
                }
                
                // Confronto esatto stringa con stringa
                const isMatch = (dataAssenzaStr === dataTarget);
                
                if (isMatch) {
                    console.log(`TROVATO ASSENTE: ${a.dipendente.nome} ${a.dipendente.cognome} in data ${dataAssenzaStr}`);
                }
                return isMatch;
            }).map(a => a.dipendente.id);

            console.log("Lista ID Assenti bloccati:", idAssentiOggi);

            tuttiDipendenti.forEach(d => {
                // Se l'ID √® nella lista degli assenti, SALTA
                if (idAssentiOggi.includes(d.id)) {
                    return; 
                }
                
                // 1. Calcolo Ore Settimanali
                const turniSettimana = tuttiITurni.filter(t => t.dipendente.id === d.id && t.data >= weekStart && t.data <= weekEnd);
                let oreFatte = 0;
                turniSettimana.forEach(t => {
                    let hIn = parseInt(t.oraInizio.split(':')[0]);
                    let hOut = parseInt(t.oraFine.split(':')[0]);
                    if(hOut < hIn) hOut += 24;
                    oreFatte += (hOut - hIn);
                });

                // 2. Controllo se lavora gi√† OGGI
                const turniOggi = tuttiITurni.filter(t => t.dipendente.id === d.id && t.data === dataTarget);
                let classeStile = "";

                if (turniOggi.length > 0) {
                    classeStile = "impegnato"; 
                } else if (oreFatte >= d.oreSettimanaliContratto) {
                    classeStile = "straordinario"; 
                }

                let label = `${d.nome} ${d.cognome} (${oreFatte}/${d.oreSettimanaliContratto}h)`;
                
                const option = document.createElement('option');
                option.value = d.id; 
                option.text = label; 
                option.className = classeStile;
                select.appendChild(option);
            });
            document.getElementById('modalAggiungi').style.display = 'flex';
        } catch (error) {
            console.error("Errore apertura modale:", error);
            alert("Si √® verificato un errore nel caricamento dei dipendenti.");
        }
    }

    async function salvaTurnoManuale() {
        const dipId = parseInt(document.getElementById('selectDipendente').value);
        const data = document.getElementById('addDateValue').value;
        const start = document.getElementById('addStart').value;
        const end = document.getElementById('addEnd').value;

        if(!dipId) { alert("Seleziona un dipendente"); return; }
        if(!start || !end) { alert("Inserisci orari validi"); return; }

        // --- CONTROLLO SOVRAPPOSIZIONE ---
        let newStartMins = timeToMinutes(start);
        let newEndMins = timeToMinutes(end);
        if (newEndMins < newStartMins) newEndMins += 24 * 60; 

        const turniEsistenti = tuttiITurni.filter(t => t.dipendente.id === dipId && t.data === data);

        let conflict = false;
        let conflictTime = "";

        turniEsistenti.forEach(t => {
            let exStart = timeToMinutes(t.oraInizio);
            let exEnd = timeToMinutes(t.oraFine);
            if (exEnd < exStart) exEnd += 24 * 60;

            if (newStartMins < exEnd && exStart < newEndMins) {
                conflict = true;
                conflictTime = `${t.oraInizio} - ${t.oraFine}`;
            }
        });

        if(conflict) {
            alert(`ERRORE: ${conflictTime} √® gi√† coperto! Questo dipendente √® gi√† in turno dalle ${conflictTime}. Non puoi sovrapporre i turni.`);
            return; 
        }

        const res = await fetch('/api/turni/manuale', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ dipendenteId: dipId, data: data, oraInizio: start, oraFine: end })
        });

        if(res.ok) { alert("Turno salvato!"); location.reload(); }
        else { 
            const errText = await res.text();
            alert("Errore nel salvataggio: " + errText); 
        }
    }

    async function eliminaTurno(id) {
        if(confirm("Eliminare questo turno?")) {
            await fetch(`/api/turni/${id}`, { method: 'DELETE' });
            location.reload();
        }
    }
    
    async function generaTurni(d) { if(confirm("Generare i turni automaticamente?")) callGeneraApi(d); }
    async function ricalcolaTurni(d) { if(confirm("Ricalcolare i turni? I turni attuali verranno persi.")) callGeneraApi(d); }
    
    async function callGeneraApi(d) {
        const res = await fetch(`/api/turni/genera?data=${d}`, { method: 'POST' });
        if(res.ok) { alert("Operazione completata!"); location.reload(); }
        else alert("Errore durante la generazione");
    }

    function chiudiModal(id) { document.getElementById(id).style.display = 'none'; }

    initCalendario();
</script>

</body>
</html>