<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>SmartShift - Calendario</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="navbar">
    <a href="index.html">Home</a>
    <a href="calendario.html" class="active">Calendario</a>
    <a href="dipendenti.html">Gestione Dipendenti</a>
</div>

<div class="container">
    <h1>Pianificazione Settimanale</h1>
    <p>Seleziona una settimana per visualizzarla o per generare i turni.</p>

    <div id="lista-settimane"></div>

    <div id="modalTurni" class="modal">
        <div class="modal-content" style="width: 95%; max-width: 1400px; height: 90vh;">
            <span class="close" onclick="chiudiModal()">&times;</span>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="modalTitle" style="margin:0;">Turni Settimana</h2>
            </div>
            
            <div id="calendarGrid" class="calendar-grid">
                </div>
        </div>
    </div>
</div>

<script>
    let tuttiITurni = [];

    // 1. Calcola le prossime 5 settimane
    function getNextWeeks() {
        let weeks = [];
        let current = new Date();
        // Imposta al Luned√¨ corrente
        let day = current.getDay();
        let diff = current.getDate() - day + (day == 0 ? -6 : 1);
        current.setDate(diff);

        for (let i = 0; i < 5; i++) {
            let start = new Date(current);
            let end = new Date(current);
            end.setDate(start.getDate() + 6);
            
            weeks.push({
                start: start,
                end: end,
                startStr: start.toISOString().split('T')[0],
                endStr: end.toISOString().split('T')[0]
            });
            
            current.setDate(current.getDate() + 7);
        }
        return weeks;
    }

    // 2. Carica dati e costruisci UI
    async function initCalendario() {
        try {
            const res = await fetch('/api/turni');
            if(res.ok) tuttiITurni = await res.json();
        } catch(e) { console.log("API non raggiunta, uso array vuoto"); }

        const weeks = getNextWeeks();
        const container = document.getElementById('lista-settimane');
        container.innerHTML = ''; // Pulisce container per evitare duplicati al reload

        weeks.forEach(week => {
            const hasShifts = tuttiITurni.some(t => {
                return t.data >= week.startStr && t.data <= week.endStr;
            });

            const div = document.createElement('div');
            div.className = `week-card ${hasShifts ? 'generated' : 'empty'}`;
            
            // Qui inseriamo la logica dei DUE bottoni
            let buttonsHtml = '';
            
            if (hasShifts) {
                // Se i turni esistono: Mostra Calendario + Ricalcola
                buttonsHtml = `
                    <button class="btn-primary" onclick="vediTurni('${week.startStr}', '${week.endStr}')">Mostra Calendario</button>
                    <button class="btn-warning" onclick="ricalcolaTurni('${week.startStr}')" style="margin-left: 10px;">üîÑ Ricalcola</button>
                `;
            } else {
                // Se √® vuota: Solo Genera
                buttonsHtml = `
                    <button class="btn-success" onclick="generaTurni('${week.startStr}')">Genera Turni</button>
                `;
            }

            div.innerHTML = `
                <div>
                    <h3>Settimana ${week.start.toLocaleDateString()} - ${week.end.toLocaleDateString()}</h3>
                    <span style="color: ${hasShifts ? 'green' : 'red'}">
                        ${hasShifts ? '‚úÖ Pianificata' : '‚ö†Ô∏è Da Pianificare'}
                    </span>
                </div>
                <div>
                    ${buttonsHtml}
                </div>
            `;
            container.appendChild(div);
        });
    }

    function vediTurni(startStr, endStr) {
        const modal = document.getElementById('modalTurni');
        const gridContainer = document.getElementById('calendarGrid');
        const modalTitle = document.getElementById('modalTitle');
        
        gridContainer.innerHTML = ''; 
        modalTitle.innerText = `Turni dal ${startStr} al ${endStr}`;

        let currentDay = new Date(startStr);

        for (let i = 0; i < 7; i++) {
            const dateKey = currentDay.toISOString().split('T')[0];
            const turniDelGiorno = tuttiITurni.filter(t => t.data === dateKey);
            turniDelGiorno.sort((a,b) => a.oraInizio.localeCompare(b.oraInizio));

            let cardsHtml = '';
            if (turniDelGiorno.length === 0) {
                cardsHtml = `<div class="no-shift">-</div>`;
            } else {
                turniDelGiorno.forEach(t => {
                    cardsHtml += `
                        <div class="shift-card">
                            <div class="shift-name">üë§ ${t.dipendente.nome} ${t.dipendente.cognome.charAt(0)}.</div>
                            <div class="shift-time">‚è∞ ${t.oraInizio} - ${t.oraFine}</div>
                        </div>
                    `;
                });
            }

            const options = { weekday: 'short', day: '2-digit', month: '2-digit' };
            const labelData = currentDay.toLocaleDateString('it-IT', options);

            const columnHtml = `
                <div class="day-column">
                    <div class="day-header">${labelData}</div>
                    <div class="day-body">${cardsHtml}</div>
                </div>
            `;
            gridContainer.innerHTML += columnHtml;
            currentDay.setDate(currentDay.getDate() + 1);
        }

        modal.style.display = 'flex';
    }

    // Genera turni per una settimana vuota
    async function generaTurni(lunediDate) {
        if(!confirm("Vuoi avviare l'algoritmo per questa settimana?")) return;
        callGeneraApi(lunediDate);
    }

    // NUOVA FUNZIONE: Ricalcola turni esistenti
    async function ricalcolaTurni(lunediDate) {
        if(!confirm("ATTENZIONE: Ricalcolare i turni CANCELLER√Ä la pianificazione attuale per questa settimana.\n\nSei sicuro di voler procedere?")) return;
        callGeneraApi(lunediDate);
    }

    // Funzione unica per chiamare l'API (usata da entrambi i tasti)
    async function callGeneraApi(lunediDate) {
        // Aggiungiamo un parametro timestamp per evitare cache
        const res = await fetch(`/api/turni/genera?data=${lunediDate}&t=${Date.now()}`, { method: 'POST' });
        
        if(res.ok) {
            alert("Turni elaborati con successo!");
            location.reload(); 
        } else {
            alert("Errore durante l'elaborazione dei turni.");
        }
    }

    function chiudiModal() {
        document.getElementById('modalTurni').style.display = 'none';
    }

    initCalendario();
</script>

</body>
</html>